import{s as e,a as t,b as s,V as a,G as n,A as i,D as l,S as o,R as r,c,d as h,e as u,f as d,g as p,h as y,i as f,j as m,k as g,l as v,m as $,n as b,o as w,p as A,q as x,r as q,t as N,u as S,B as k,v as O,w as E,x as F,y as M,z as C,C as T,E as G,F as L,P as R,H as B,N as j,I as D,J as V,O as P,K as U,L as _,M as W,Q as Y,T as z,U as I,W as H,X as J,Y as K,Z as Q,_ as X,$ as Z,a0 as ee,a1 as te,a2 as se,a3 as ae,a4 as ne,a5 as ie,a6 as le,a7 as oe,a8 as re,a9 as ce,aa as he,ab as ue,ac as de,ad as pe,ae as ye,af as fe,ag as me,ah as ge,ai as ve,aj as $e,ak as be,al as we}from"./notes-715bae62.js";const Ae=2*Math.PI;function xe({m:a,e:n,s:i,"Œ∏":l,h:o,"Œ¶":r,"ùúì":c,"Œ¥x":h,"Œ¥y":u,shape:d},p){const y=new Array(p),f=Ae/p;for(let e=0;e<p;e++)y[e]=e*f;switch(d){case"ellipse":return s(y,{m:a,e:n,s:i,"Œ∏":l,h:o,"Œ¶":r,"ùúì":c,"Œ¥x":h,"Œ¥y":u});case"square":case"cowbell":return t(y,{m:a,e:n,s:i,"Œ∏":l,h:o,"Œ¶":r,"ùúì":c,"Œ¥x":h,"Œ¥y":u});default:return e(y,{m:a,e:n,s:i,"Œ∏":l,h:o,"Œ¶":r,"ùúì":c,"Œ¥x":h,"Œ¥y":u})}}const qe=new Map([[`${a}`,"volume"],[`${n}`,"gain"],[`${i}`,"attack"],[`${l}`,"decay"],[`${o}`,"sustain"],[`${r}`,"release"],[c,"R.Œµ"],[h,"R.ùóå"],[u,"R.Œ∏"],[d,"R.a"],[p,"R.Œ¥x"],[y,"R.Œ¥y"],[f,"R.Œ¶"],[m,"R.ùúì"],[g,"R.b"],[v,"G.Œµ"],[$,"G.ùóå"],[b,"G.Œ∏"],[w,"G.a"],[A,"G.Œ¥x"],[x,"G.Œ¥y"],[q,"G.Œ¶"],[N,"G.ùúì"],[S,"G.b"],[k,"B.Œµ"],[`${O}`,"B.ùóå"],[`${E}`,"B.Œ∏"],[F,"B.a"],[M,"B.Œ¥x"],[C,"B.Œ¥y"],[T,"B.Œ¶"],[G,"B.ùúì"],[L,"B.b"]]);class Ne extends AudioWorkletNode{constructor(e,t){super(e,t,{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]}),this.internal={state:"stopped",envelope:""},this.sab={parameters:null,variations:null,metrics:null,patchbay:null},this.port.onmessage=this.onMessage.bind(this)}get metrics(){return null!=this.sab.metrics?function(e){const t=new Float64Array(e,0,64);return{power:t[0],level:t[1],volume:t[2],clipping:t[3],dropping:t[4],duration:t[5],notes:t[6],maxNotes:t[7]}}(this.sab.metrics):{power:0,level:0,volume:0,clipping:0,dropping:0,duration:0}}get state(){return this.internal.state}get patchbay(){return this.sab.patchbay}onMessage(e){switch(e.data.message){case"sab.parameters":this.sab.parameters=e.data.sab,this.sab.pages=e.data.pages,this.sab.version=e.data.version;break;case"sab.variations":this.sab.variations=e.data.sab,this.sab.patchbay=new Float64Array(this.sab.variations,0,e.data.size);break;case"sab.metrics":this.sab.metrics=e.data.sab;break;case"state":this.internal.state=e.data.state}}keyPressed(e){e&&this.port.postMessage({message:"keyPressed",timestamp:this.context.currentTime,note:e})}keyReleased(e){e&&this.port.postMessage({message:"keyReleased",timestamp:this.context.currentTime,note:e})}play(e){e&&this.port.postMessage({message:"play",timestamp:this.context.currentTime,song:e})}pause(){this.port.postMessage({message:"pause",timestamp:this.context.currentTime})}stop(){this.port.postMessage({message:"stop",timestamp:this.context.currentTime})}patch(e,t){this.port.postMessage({message:"patch",timestamp:this.context.currentTime,lfo:e,plug:Se(t)})}}function Se(e){return qe.has(e)?qe.get(e):""}const ke=[6,15,24],Oe=[7,16,25],Ee=[8,17,26],Fe=[9,18,27],Me=[10,19,28],Ce=[11,20,29],Te=[12,21,30],Ge=[13,22,31],Le=[14,23,32],Re=function(e){return Math.PI*e/180};class Be extends Ne{constructor(e){super(e,"wavetable"),this.internal={parameters:[new R({m:1,e:.75,s:10,"Œ∏":30,h:.5,"Œ¥x":0,"Œ¥y":0,"Œ¶":0,"ùúì":0,balance:0,shape:"ellipse"}),new R({m:2,e:0,s:10,"Œ∏":0,h:.3,"Œ¥x":0,"Œ¥y":0,"Œ¶":0,"ùúì":0,balance:0,shape:"ellipse"}),new R({m:4,e:0,s:10,"Œ∏":0,h:.2,"Œ¥x":0,"Œ¥y":0,"Œ¶":0,"ùúì":0,balance:0,shape:"ellipse"})],envelope:{type:"AR",attack:.05,decay:0,sustain:1,release:.1}},this.shared={N:0,wavetable:[],version:0}}onMessage(e){if("wavetable"===e.data.message){const t=e.data.sab,s=e.data.N,a=e.data.pages,n=s*Float32Array.BYTES_PER_ELEMENT,i=[];for(let e=0;e<a;e++){const a=6*e*n,l=0*s*Float32Array.BYTES_PER_ELEMENT,o=1*s*Float32Array.BYTES_PER_ELEMENT,r=2*s*Float32Array.BYTES_PER_ELEMENT,c=3*s*Float32Array.BYTES_PER_ELEMENT,h=4*s*Float32Array.BYTES_PER_ELEMENT,u=5*s*Float32Array.BYTES_PER_ELEMENT;i.push({RL:new Float32Array(t,a+l,s),RR:new Float32Array(t,a+o,s),GL:new Float32Array(t,a+r,s),GR:new Float32Array(t,a+c,s),BL:new Float32Array(t,a+h,s),BR:new Float32Array(t,a+u,s)})}this.shared.N=s,this.shared.wavetable=i,this.shared.version=e.data.version}super.onMessage(e)}set(e,t){this.internal.parameters=e,this.internal.envelope=t.clone(),this.regenerate()}regenerate(){return new Promise((()=>{performance.now();const e=this.shared.N,t=this.shared.wavetable.length,s=this.internal.parameters,a=this.patchbay;if(t>0){const n=(this.shared.version+1)%t,i=this.shared.wavetable[n],[l,o,r]=function(e,t,s){const a=e.map(((e,s)=>({m:e.m,e:e.e*t[ke[s]],s:e.s*t[Oe[s]],"Œ∏":Re(e.Œ∏*t[Ee[s]]),h:e.h*t[Fe[s]],"Œ¥x":e.Œ¥x*t[Me[s]],"Œ¥y":e.Œ¥y*t[Ce[s]],"Œ¶":Re(e.Œ¶)*t[Te[s]],"ùúì":e["ùúì"]*t[Ge[s]],balance:e.balance*t[Le[s]],shape:e.shape}))),n=a.map((({m:e,e:t,s:s,"Œ∏":a,h:n,"Œ¥x":i,"Œ¥y":l,"Œ¶":o,"ùúì":r,balance:c,shape:h})=>({left:{m:e,e:t,s:s,"Œ∏":a,h:n,"Œ¶":o,"ùúì":0,"Œ¥x":i,"Œ¥y":l,shape:h},right:{m:e,e:t,s:s,"Œ∏":a,h:n,"Œ¶":o,"ùúì":0,"Œ¥x":i,"Œ¥y":l,shape:h},balance:{ll:(1-c)/2,lr:(1+c)/2}}))).map((({left:e,right:t,balance:a})=>({snl:xe(e,s).map((e=>a.ll*e)),snr:xe(t,s).map((e=>a.lr*e))})));return n}(s,a,e);i.RL.set(l.snl),i.RR.set(l.snr),i.GL.set(o.snl),i.GR.set(o.snr),i.BL.set(r.snl),i.BR.set(r.snr),this.shared.version=(this.shared.version+1)%1048575,this.port.postMessage({message:"load",timestamp:this.context.currentTime,version:this.shared.version,parameters:this.internal.parameters,envelope:this.internal.envelope})}performance.now()}))}}class je extends Ne{constructor(e){super(e,"dds")}set(e,t){if(null!=this.sab.parameters){const s=this.sab.version+1,a=s%(this.sab.pages<1?1:this.sab.pages);B(s,e,t,this.sab.parameters,a),this.sab.version=s,this.port.postMessage({message:"parameters.updated",version:s})}}}class De extends AudioWorkletNode{constructor(e,t){super(e,t,{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1]}),this.port.onmessage=this.onMessage.bind(this),this.wavetable=[],this.version=0,this.table=null}onMessage(e){if("wavetable"===e.data.message){const t=e.data.sab,s=e.data.N,a=e.data.pages,n=s*Float32Array.BYTES_PER_ELEMENT,i=[];for(let e=0;e<a;e++)i.push(new Float32Array(t,e*n,s));this.wavetable=i,this.version=e.data.version,null!=this.table&&Ve(this,this.table)}}load(e){if(this.table=e,this.wavetable.length>0)return new Promise((()=>{this.version=Ve(this,e)}))}}function Ve(e,t){const s=e.wavetable.length,a=(e.version+1)%s,n=e.wavetable[a],i=(e.version+1)%1048575;return n.set(t),e.port.postMessage({message:"wavetable",version:i}),i}const Pe=255,Ue=3,_e=47,We=81,Ye=128,ze=144;function Ie(e){for(const t of e.events)if(t.status===Pe&&t.type===Ue)return String.fromCharCode(...t.data);return""}function He(e,t,s){const a=[];let n=0;for(const t of e.events)if(n+=t.delta,t.status<255&&(240&t.status)===ze&&a.push({tick:n,event:t}),t.status<255&&(240&t.status)===Ye&&a.push({tick:n,event:t}),t.status===Pe&&t.type===_e)break;a.push(...t),a.sort(((e,t)=>e.tick-t.tick));let i=5e4,l=0;for(const e of a)l+=1e3*e.event.delta*i/s,e.at=Math.round(l/1e6)/1e3,e.event.status===Pe&&e.event.type===We&&(i=0,e.event.data.forEach((e=>{i<<=8,i+=e})));return a}function Je(e){const t=new Map,s=new Map;for(let e=0;e<16;e++)s.set(e,[]);for(const t of e){if(t.event.status<255&&(240&t.event.status)===ze){const e=t.event.channel,a=s.get(e);a.push(t),s.set(e,a)}if(t.event.status<255&&(240&t.event.status)===Ye){const e=t.event.channel,a=s.get(e);a.push(t),s.set(e,a)}}s.forEach(((e,t)=>{0===e.length&&s.delete(t)}));for(const[e,a]of s){const s=new Map;t.set(e,[]);for(const n of a){if(n.event.status<255&&(240&n.event.status)===ze&&n.event.data[1]>0){const e=n.event.data[0],t=n.event.data[1];s.has(e)?console.error(`NoteOn without NoteOff ${n.at} ${e}`):s.set(e,{note:e,at:n.at,velocity:t})}if(n.event.status<255&&(240&n.event.status)===ze&&0===n.event.data[1]){const a=n.event.data[0],i=n.event.data[1];if(s.has(a)){const l=s.get(a),o=t.get(e);o.push({note:l.note,start:l.at,end:n.at,attack:l.velocity,release:i}),t.set(e,o),s.delete(a)}else console.error(`NoteOff without NoteOn ${n.event}`)}if(n.event.status<255&&(240&n.event.status)===Ye){const a=n.event.data[0],i=n.event.data[1];if(s.has(a)){const l=s.get(a),o=t.get(e);o.push({note:l.note,start:l.at,end:n.at,attack:l.velocity,release:i}),t.set(e,o),s.delete(a)}else console.error(`NoteOff without NoteOn ${n.event}`)}}}return t}function Ke(e){const t=[];let s=0;const a=function(e){const t=new DataView(e),s=(new TextDecoder).decode(e.slice(0,4)),a=t.getUint32(4),n=t.getUint16(8),i=t.getUint16(10),l=t.getUint16(12);return{tag:s,length:a,format:n,tracks:i,division:l}}(e.slice(s));s+=8,s+=a.length;for(let n=0;n<a.tracks;n++){const a=Xe(e.slice(s));s+=8,s+=a.length,t.push(a)}return{MThd:a,tracks:t}}function Qe(e){const t=[],s=Ie(e.tracks[0]),a=e.MThd.division,n=function(e){const t=[];let s=0;for(const a of e.tracks[0].events)s+=a.delta,a.status===Pe&&a.type===We&&t.push({tick:s,event:{delta:0,status:a.status,type:a.type,data:a.data}});return t}(e);for(const s of e.tracks.slice(1)){const e=Ie(s),i=Je(He(s,n,a));t.push({name:e,notes:i})}const i=new Map(Array.from(j).map((([e,t])=>[t.midi,e]))),l=[];return t.forEach((e=>{e.notes.forEach((e=>{e.forEach((e=>{i.has(e.note)&&l.push({note:i.get(e.note),velocity:e.attack,start:e.start,end:e.end})}))}))})),l.sort(((e,t)=>e.start-t.start)),s.replaceAll(/\s+|[.\-+_,;]+/gim,"").includes("stairwaytoheaven")?(console.log("No Stairway to Heaven"),{name:s,notes:[]}):{name:s,notes:l}}function Xe(e){const t=new DataView(e),s=(new TextDecoder).decode(e.slice(0,4)),a=t.getUint32(4),n=function*(e){let t=0,s=0;const a=function(){let t=0;for(;s<e.length;){const a=e[s];if(s++,t=(t<<7)+(127&a),0==(128&a))break}return t},n=function(){const t=[];let n=a();for(;s<e.length&&n>0;)t.push(e[s]),s++,n--;return t};for(;s<e.length;){const i=a();if(s<e.length&&255===e[s]){t=0;const a=e[s];s++;const l=e[s];s++;const o={delta:i,status:a,type:l,data:n()};yield o;continue}if(s<e.length&&(240===e[s]||247===e[s])){t=0;const a=e[s];s++;const l={delta:i,status:a,data:n()};yield l;continue}let l=t;if(s<e.length&&e[s]>=128&&e[s]<=239&&(l=e[s],s++,t=l),l<128||l>239)throw new Error(`invalid MIDI event (${l})`);const o=240&l,r=15&l,c=[];switch(o){case 128:case 144:case 176:case 224:c.push(e[s]),s++,c.push(e[s]),s++;break;case 160:case 192:case 208:c.push(e[s]),s++}const h={delta:i,status:l,type:o,channel:r,data:c};yield h}}(new Uint8Array(e.slice(8,8+a)));return{tag:s,length:a,events:Array.from(n)}}const Ze=[{note:"A4",velocity:100,start:2.082,end:2.499},{note:"C5",velocity:100,start:2.499,end:3.332},{note:"A4",velocity:100,start:2.499,end:3.332},{note:"A3",velocity:100,start:2.499,end:3.748},{note:"D5",velocity:100,start:3.332,end:3.748},{note:"E5",velocity:100,start:3.748,end:4.373},{note:"C5",velocity:100,start:3.748,end:4.373},{note:"C4",velocity:100,start:3.748,end:4.998},{note:"F5",velocity:100,start:4.373,end:4.581},{note:"E5",velocity:100,start:4.581,end:4.998},{note:"D5",velocity:100,start:4.998,end:5.831},{note:"G4",velocity:100,start:4.998,end:5.831},{note:"G3",velocity:100,start:4.998,end:6.247},{note:"B4",velocity:100,start:5.831,end:6.247},{note:"G4",velocity:100,start:6.247,end:6.872},{note:"D4",velocity:100,start:6.247,end:6.872},{note:"G3",velocity:100,start:6.247,end:7.497},{note:"A4",velocity:100,start:6.872,end:7.08},{note:"B4",velocity:100,start:7.08,end:7.497},{note:"C5",velocity:100,start:7.497,end:8.33},{note:"A4",velocity:100,start:7.497,end:8.33},{note:"A3",velocity:100,start:7.497,end:8.746},{note:"A4",velocity:100,start:8.33,end:8.746},{note:"A4",velocity:100,start:8.746,end:9.371},{note:"A3",velocity:100,start:8.746,end:9.996},{note:"G#4",velocity:100,start:9.371,end:9.579},{note:"A4",velocity:100,start:9.579,end:9.996},{note:"B4",velocity:100,start:9.996,end:10.829},{note:"E3",velocity:100,start:9.996,end:12.495},{note:"G#4",velocity:100,start:10.829,end:11.245},{note:"E4",velocity:100,start:11.245,end:12.078},{note:"A4",velocity:100,start:12.078,end:12.495},{note:"C5",velocity:100,start:12.495,end:13.328},{note:"A4",velocity:100,start:12.495,end:13.328},{note:"A3",velocity:100,start:12.495,end:13.744},{note:"D5",velocity:100,start:13.328,end:13.744},{note:"E5",velocity:100,start:13.744,end:14.369},{note:"C5",velocity:100,start:13.744,end:14.369},{note:"C4",velocity:100,start:13.744,end:14.994},{note:"F5",velocity:100,start:14.369,end:14.577},{note:"E5",velocity:100,start:14.577,end:14.994},{note:"D5",velocity:100,start:14.994,end:15.827},{note:"G4",velocity:100,start:14.994,end:15.827},{note:"G3",velocity:100,start:14.994,end:16.243},{note:"B4",velocity:100,start:15.827,end:16.243},{note:"G4",velocity:100,start:16.243,end:16.868},{note:"D4",velocity:100,start:16.243,end:16.868},{note:"G3",velocity:100,start:16.243,end:17.493},{note:"A4",velocity:100,start:16.868,end:17.076},{note:"B4",velocity:100,start:17.076,end:17.493},{note:"C5",velocity:100,start:17.493,end:18.117},{note:"A4",velocity:100,start:17.493,end:18.117},{note:"A3",velocity:100,start:17.493,end:18.742},{note:"B4",velocity:100,start:18.117,end:18.326},{note:"A4",velocity:100,start:18.326,end:18.742},{note:"G#4",velocity:100,start:18.742,end:19.367},{note:"E3",velocity:100,start:18.742,end:19.992},{note:"F#4",velocity:100,start:19.367,end:19.575},{note:"G#4",velocity:100,start:19.575,end:19.992},{note:"A4",velocity:100,start:19.992,end:21.241},{note:"A3",velocity:100,start:19.992,end:21.241},{note:"A4",velocity:100,start:21.241,end:22.491},{note:"A3",velocity:100,start:21.241,end:22.491},{note:"G5",velocity:100,start:22.491,end:23.74},{note:"B4",velocity:100,start:22.491,end:23.74},{note:"G4",velocity:100,start:22.491,end:23.74},{note:"G3",velocity:100,start:22.491,end:23.74},{note:"G4",velocity:100,start:23.74,end:24.365},{note:"B4",velocity:100,start:23.74,end:24.365},{note:"G5",velocity:100,start:23.74,end:24.365},{note:"G3",velocity:100,start:23.74,end:24.99},{note:"F#5",velocity:100,start:24.365,end:24.573},{note:"E5",velocity:100,start:24.573,end:24.99},{note:"D5",velocity:100,start:24.99,end:25.823},{note:"G4",velocity:100,start:24.99,end:25.823},{note:"G3",velocity:100,start:24.99,end:26.239},{note:"B4",velocity:100,start:25.823,end:26.239},{note:"G4",velocity:100,start:26.239,end:26.864},{note:"D4",velocity:100,start:26.239,end:26.864},{note:"G3",velocity:100,start:26.239,end:27.489},{note:"A4",velocity:100,start:26.864,end:27.072},{note:"B4",velocity:100,start:27.072,end:27.489},{note:"C5",velocity:100,start:27.489,end:28.322},{note:"A4",velocity:100,start:27.489,end:28.322},{note:"A3",velocity:100,start:27.489,end:28.738},{note:"A4",velocity:100,start:28.322,end:28.738},{note:"A4",velocity:100,start:28.738,end:29.363},{note:"A3",velocity:100,start:28.738,end:29.988},{note:"G#4",velocity:100,start:29.363,end:29.571},{note:"A4",velocity:100,start:29.571,end:29.988},{note:"B4",velocity:100,start:29.988,end:30.821},{note:"E3",velocity:100,start:29.988,end:32.487},{note:"G#4",velocity:100,start:30.821,end:31.237},{note:"E4",velocity:100,start:31.237,end:32.487},{note:"G5",velocity:100,start:32.487,end:33.736},{note:"B4",velocity:100,start:32.487,end:33.736},{note:"G4",velocity:100,start:32.487,end:33.736},{note:"G3",velocity:100,start:32.487,end:33.736},{note:"G5",velocity:100,start:33.736,end:34.361},{note:"B4",velocity:100,start:33.736,end:34.361},{note:"G4",velocity:100,start:33.736,end:34.361},{note:"G3",velocity:100,start:33.736,end:34.986},{note:"F#4",velocity:100,start:34.361,end:34.569},{note:"E5",velocity:100,start:34.569,end:34.986},{note:"D5",velocity:100,start:34.986,end:35.819},{note:"G4",velocity:100,start:34.986,end:35.819},{note:"G3",velocity:100,start:34.986,end:36.235},{note:"B4",velocity:100,start:35.819,end:36.235},{note:"G4",velocity:100,start:36.235,end:36.86},{note:"D4",velocity:100,start:36.235,end:36.86},{note:"G3",velocity:100,start:36.235,end:37.485},{note:"A4",velocity:100,start:36.86,end:37.068},{note:"B4",velocity:100,start:37.068,end:37.485},{note:"C5",velocity:100,start:37.485,end:38.318},{note:"A4",velocity:100,start:37.485,end:38.318},{note:"A3",velocity:100,start:37.485,end:38.734},{note:"A4",velocity:100,start:38.318,end:38.734},{note:"G#4",velocity:100,start:38.734,end:39.359},{note:"E3",velocity:100,start:38.734,end:39.984},{note:"F#4",velocity:100,start:39.359,end:39.567},{note:"G#4",velocity:100,start:39.567,end:39.984},{note:"A4",velocity:100,start:39.984,end:41.233},{note:"E4",velocity:100,start:39.984,end:41.233},{note:"A3",velocity:100,start:39.984,end:41.233},{note:"A4",velocity:100,start:41.233,end:42.483},{note:"E4",velocity:100,start:41.233,end:42.483},{note:"A3",velocity:100,start:41.233,end:42.483}],et=new Map([[0,["A","A#","B"]],[1,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[2,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[3,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[4,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[5,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[6,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[7,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]],[8,["C"]]]);class tt{constructor(e,t,s){this.internal={oid:e,url:t,title:s,notes:[],data:new Uint8Array}}get oid(){return this.internal.oid}get url(){return this.internal.url}set url(e){this.internal.url=e}get title(){return this.internal.title}set title(e){this.internal.title=e}get notes(){return this.internal.notes}set notes(e){this.internal.notes=e}get data(){return this.internal.data}set data(e){this.internal.data=e}stash(e,t){const s=e=>{const s=Qe(Ke(e));this.title=""===s.name?t:s.name,this.url=t,this.notes=s.notes,this.data=new Uint8Array(e),pt(`${this.oid}${V.playlist.slot.url}`,{url:this.url,title:this.title})};return e.arrayBuffer().then((e=>s(e)))}reset(){this.title="",this.url="",this.notes=[],this.data=new Uint8Array,pt(`${this.oid}${V.playlist.slot.url}`,{url:this.url,title:this.title})}}const st=[new tt(`${z.playlist}${V.playlist.slots}.1`,"",""),new tt(`${z.playlist}${V.playlist.slots}.2`,"",""),new tt(`${z.playlist}${V.playlist.slots}.3`,"",""),new tt(`${z.playlist}${V.playlist.slots}.4`,"",""),new tt(`${z.playlist}${V.playlist.slots}.5`,"",""),new tt(`${z.playlist}${V.playlist.slots}.6`,"",""),new tt(`${z.playlist}${V.playlist.slots}.7`,"./midi/greensleeves.mid","Greensleeves"),new tt(`${z.playlist}${V.playlist.slots}.8`,"./midi/greensleeves-too.mid","Greensleeves Too"),new tt(`${z.playlist}${V.playlist.slots}.9`,"./midi/take-five.mid","Take Five"),new tt(`${z.playlist}${V.playlist.slots}.10`,"",""),new tt(`${z.playlist}${V.playlist.slots}.12`,"",""),new tt(`${z.playlist}${V.playlist.slots}.12`,"","")],at=new class{constructor(){this.internal={current:null}}get current(){return this.internal.current}set current(e){this.internal.current=e}},nt=new Map;let it=0;function lt(e,t){const s=st.find((t=>t.oid===`${e}`));return new Promise(((e,a)=>{null!=s&&""!==s.url?e(s.url):""===t||t.startsWith("file://")?a(new Error("slot has no URL")):e(t)})).then((t=>{if(t.startsWith("file://"))return ut(s.title,s.url,s.notes,s.data);if(s.notes.length>0||s.data.length>0)return ut(s.title,s.url,s.notes,s.data);return ht(e,t).then((e=>e.arrayBuffer())).then((e=>(e=>{const s=Qe(Ke(e));return{name:s.name,file:t,notes:s.notes,data:new Uint8Array(e)}})(e))).catch((e=>dt(s)))}))}function ot(e){null==e||e===D?([...nt.keys()].filter((e=>P.contains(e,D))).forEach((e=>nt.delete(e))),pt(`${D}${V.playlist.song.state}`,"dequeued")):nt.has(e)&&(nt.delete(e),pt(`${e}${V.playlist.slot.state}`,"dequeued"))}function rt(e,t,s){const a=st.find((t=>t.oid===`${e}`));if(null!=a&&"file"===s&&a.stash(t,`file://${t.name}`).then((()=>ct())),null!=a&&"url"===s)return ht(e,t).then((e=>a.stash(e,t))).then((()=>ct())).catch((e=>dt(a)))}function ct(){const e={slots:[]};for(const t of st)e.slots.push({oid:t.oid,url:t.url,title:t.title,data:Array.from(t.data)});_("playlist",e)}function ht(e,t){return fetch(t,{method:"GET",mode:"cors",cache:"no-cache",credentials:"same-origin",redirect:"follow",referrerPolicy:"no-referrer",headers:{Accept:"application/octet-stream","Accept-Encoding":"gzip"}}).then((e=>(e=>{if(200===e.status)return e.blob();throw new Error(e.statusText)})(e)))}function ut(e,t,s,a){if((null==s||0===s.length)&&null!=a&&a.length>0){const e=Qe(Ke(a.buffer));return new Promise((s=>{s({name:e.name,file:t,notes:e.notes,data:a})}))}return new Promise((n=>{n({name:e,file:t,notes:s,data:a})}))}function dt(e,t){pt(`${e.oid}${V.playlist.slot.state}`,"error")}function pt(e,t){Y(new CustomEvent("changed",{detail:{oid:e,value:t}}))}class yt{constructor(e,t,s,a,n,i,l,o,r,c,h,u){this.internal={oid:e,multiplier:t,eccentricity:s,sensitivity:a,rotation:n,amplitude:i,shiftx:l,shifty:o,phase:r,psi:c,balance:h,shape:u},this.defaults={multiplier:t,eccentricity:s,sensitivity:a,rotation:n,amplitude:i,shiftx:l,shifty:o,phase:r,psi:c,balance:h,shape:u}}get oid(){return this.internal.oid}get multiplier(){return this.internal.multiplier}set multiplier(e){const t=parseInt(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";!Number.isNaN(t)&&t>0&&t<=8&&(this.internal.multiplier=t,ft(s,this.oid,V.oscillator.multiplier,this.multiplier))}get eccentricity(){return Number(this.internal.eccentricity)}set eccentricity(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.eccentricity=mt(t,-1,1),ft(s,this.oid,V.oscillator.eccentricity,this.eccentricity))}get sensitivity(){return Number(this.internal.sensitivity)}set sensitivity(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.sensitivity=mt(t,0,20),ft(s,this.oid,V.oscillator.sensitivity,this.sensitivity))}get rotation(){return this.internal.rotation}set rotation(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.rotation=mt(t,-90,90),ft(s,this.oid,V.oscillator.rotation,this.rotation))}get amplitude(){return this.internal.amplitude}set amplitude(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.amplitude=mt(t,0,1),ft(s,this.oid,V.oscillator.amplitude,this.amplitude))}get shiftx(){return this.internal.shiftx}set shiftx(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.shiftx=mt(t,-1,1),ft(s,this.oid,V.oscillator.shiftx,this.shiftx))}get shifty(){return this.internal.shifty}set shifty(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.shifty=mt(t,-1,1),ft(s,this.oid,V.oscillator.shifty,this.shifty))}get phase(){return this.internal.phase}set phase(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.phase=mt(t,-90,90),ft(s,this.oid,V.oscillator.phase,this.phase))}get psi(){return this.internal.psi}set psi(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.psi=mt(t,-90,90),ft(s,this.oid,V.oscillator.psi,this.psi))}get balance(){return this.internal.balance}set balance(e){const t=parseFloat(Array.isArray(e)?e[0]:e),s=Array.isArray(e)&&"change"===e[1]?"change":"changed";Number.isNaN(t)||(this.internal.balance=mt(t,-1,1),ft(s,this.oid,V.oscillator.balance,this.balance))}get shape(){return this.internal.shape}set shape(e){const t=Array.isArray(e)?e[0]:e,s=Array.isArray(e)&&"change"===e[1]?"change":"changed";"ellipse"!==t&&"square"!==t&&"cowbell"!==t||(this.internal.shape=t,ft(s,this.oid,V.oscillator.shape,this.shape))}reset({m:e,"Œµ":t,"ùóå":s,"Œ∏":a,a:n,"Œ¥x":i,"Œ¥y":l,"Œ¶":o,"ùúì":r,b:c,shape:h}){this.internal.multiplier=null==e?this.defaults.multiplier:e,this.internal.eccentricity=null==t?this.defaults.eccentricity:t,this.internal.sensitivity=null==s?this.defaults.sensitivity:s,this.internal.rotation=null==a?this.defaults.rotation:a,this.internal.amplitude=null==n?this.defaults.amplitude:n,this.internal.shiftx=null==i?this.defaults.shiftx:i,this.internal.shifty=null==l?this.defaults.shifty:l,this.internal.phase=null==o?this.defaults.phase:o,this.internal.psi=null==r?this.defaults.psi:r,this.internal.balance=null==c?this.defaults.balance:c,this.internal.shape=null==h?this.defaults.shape:h}asObject(){return{m:this.multiplier,e:this.eccentricity,s:this.sensitivity,"Œ∏":this.rotation,h:this.amplitude,"Œ¥x":this.shiftx,"Œ¥y":this.shifty,"Œ¶":this.phase,"ùúì":this.psi,balance:this.balance,shape:this.shape}}serialise(){return{oid:this.oid,multiplier:this.multiplier,eccentricity:this.eccentricity,sensitivity:this.sensitivity,amplitude:this.amplitude,shiftx:this.shiftx,shifty:this.shifty,phase:this.phase,psi:this.psi,balance:this.balance,shape:this.shape}}deserialise(e){null!=e&&(!Number.isNaN(e.multiplier)&&e.multiplier>0&&e.multiplier<=8&&(this.internal.multiplier=e.multiplier),Number.isNaN(e.eccentricity)||(this.internal.eccentricity=mt(e.eccentricity,-1,1)),Number.isNaN(e.sensitivity)||(this.internal.sensitivity=mt(e.sensitivity,0,20)),Number.isNaN(e.amplitude)||(this.internal.amplitude=mt(e.amplitude,0,1)),Number.isNaN(e.shiftx)||(this.internal.shiftx=mt(e.shiftx,-1,1)),Number.isNaN(e.shifty)||(this.internal.shifty=mt(e.shifty,-1,1)),Number.isNaN(e.phase)||(this.internal.phase=mt(e.phase,-1,1)),Number.isNaN(e.psi)||(this.internal.psi=mt(e.psi,-1,1)),Number.isNaN(e.balance)||(this.internal.balance=mt(e.balance,-1,1)),"ellipse"!==e.shape&&"square"!==e.shape&&"cowbell"!==e.shape||(this.internal.shape=e.shape))}}function ft(e,t,s,a){const n=new CustomEvent(e,{detail:{oid:t+s,value:a}});Y(n)}function mt(e,t,s){return Math.min(Math.max(e,t),s)}const gt=new yt(I,1,.1,10,30,.7,0,0,0,0,0,"ellipse"),vt=new yt(H,2,0,10,0,.5,0,0,0,0,0,"ellipse"),$t=new yt(J,4,0,10,0,.3,0,0,0,0,0,"ellipse"),bt=new Map([["sn.R",gt],["sn.G",vt],["sn.B",$t]]);function wt(){return[gt,vt,$t].map((e=>new R({m:e.multiplier,e:e.eccentricity,s:e.sensitivity,"Œ∏":e.rotation,h:e.amplitude,"Œ¥x":e.shiftx,"Œ¥y":e.shifty,"Œ¶":e.phase,balance:e.balance,"ùúì":-e.psi,shape:e.shape})))}function At(e,t,s,a){if(bt.has(e)){const n=bt.get(e);switch(t){case"m":n.multiplier=[s,a];break;case"Œµ":n.eccentricity=[s,a];break;case"ùóå":n.sensitivity=[s,a];break;case"Œ∏":n.rotation=[s,a];break;case"a":n.amplitude=[s,a];break;case"Œ¥x":n.shiftx=[s,a];break;case"Œ¥y":n.shifty=[s,a];break;case"Œ¶":n.phase=[s,a];break;case"ùúì":n.psi=[s,a];break;case"b":n.balance=[s,a];break;case"shape":n.shape=[s,a]}}}let xt=class{constructor(e,t,s,a){this.internal={oid:e,on:!1,frequency:t,range:s,plug:a},this.defaults={on:!1,frequency:.1,range:{min:-1,max:1},plug:null}}get oid(){return this.internal.oid}get on(){return this.internal.on}set on(e){const[t,s]=Array.isArray(e)?e:[e,"changed"];this.internal.on=!0===t,qt(s,this.oid,V.lfo.on,this.on)}get frequency(){return this.internal.frequency}set frequency(e){const[t,s]=Array.isArray(e)?e:[e,"changed"],a=parseFloat(t);Number.isNaN(a)||(this.internal.frequency=a,qt(s,this.oid,V.lfo.frequency,this.frequency))}get range(){return this.internal.range}set range(e){const[t,s]=Array.isArray(e)?e:[e,"changed"],a=Number.isNaN(t.min)?this.range.min:parseFloat(t.min),n=Number.isNaN(t.max)?this.range.max:parseFloat(t.max);this.internal.range={min:Math.min(a,n),max:Math.max(a,n)},qt(s,this.oid,V.lfo.range.min,this.range.min),qt(s,this.oid,V.lfo.range.max,this.range.max)}get plug(){return this.internal.plug}set plug(e){const[t,s]=Array.isArray(e)?e:[e,"changed"];this.internal.plug=t,qt(s,this.oid,V.lfo.plug,this.plug)}reset(){this.frequency=this.defaults.frequency}serialise(){return{oid:this.oid,on:this.on,frequency:this.frequency,range:this.range,plug:this.plug}}deserialise(e){if(null!=e){let t=this.on,s=this.frequency,a=this.range.min,n=this.range.max,i=this.plug;!0===e.on&&(t=!0),Number.isNaN(e.frequency)||(s=e.frequency),null==e.range||Number.isNaN(e.range.min)||(a=parseFloat(`${e.range.min}`)),null==e.range||Number.isNaN(e.range.max)||(n=parseFloat(`${e.range.max}`)),null!=e.plug&&(i=e.plug),this.on=t,this.frequency=s,this.range={min:a,max:n},this.plug=i}}};function qt(e,t,s,a){const n=new CustomEvent(e,{detail:{oid:t+s,value:a}});Y(n)}const Nt=new Map([[`${a}`,"volume"],[`${n}`,"gain"],[`${i}`,"attack"],[`${l}`,"decay"],[`${o}`,"sustain"],[`${r}`,"release"],[c,"R.Œµ"],[h,"R.ùóå"],[u,"R.Œ∏"],[d,"R.a"],[p,"R.Œ¥x"],[y,"R.Œ¥y"],[f,"R.Œ¶"],[m,"R.ùúì"],[g,"R.b"],[v,"G.Œµ"],[$,"G.ùóå"],[b,"G.Œ∏"],[w,"G.a"],[A,"G.Œ¥x"],[x,"G.Œ¥y"],[q,"G.Œ¶"],[N,"G.ùúì"],[S,"G.b"],[k,"B.Œµ"],[`${O}`,"B.ùóå"],[`${E}`,"B.Œ∏"],[F,"B.a"],[M,"B.Œ¥x"],[C,"B.Œ¥y"],[T,"B.Œ¶"],[G,"B.ùúì"],[L,"B.b"]]),St=2,kt=3,Ot=4,Et=5,Ft=[6,15,24],Mt=[7,16,25],Ct=[8,17,26],Tt=[9,18,27],Gt=[10,19,28],Lt=[11,20,29];function Rt(e){const t=[...Nt],s=t.find((([t,s])=>s===e));if(null!=s)return s[0];const a=t.find((([t,s])=>t===e));return null!=a?a[1]:""}const Bt=new yt(K,1,0,10,0,.5,0,0,0,0,0,"ellipse"),jt=new yt(Q,2,0,10,0,.3,0,0,0,0,0,"ellipse"),Dt=new yt(X,4,0,10,0,.2,0,0,0,0,0,"ellipse"),Vt=new Map([["sn.R",Bt],["sn.G",jt],["sn.B",Dt]]),Pt=new Map([["lfo.1",new xt(Z,.1,{min:-1,max:1},a)],["lfo.2",new xt(ee,.1,{min:-1,max:1},n)],["lfo.3",new xt(te,.1,{min:-1,max:1},null)],["lfo.4",new xt(se,.1,{min:-1,max:1},null)]]);function Ut(e){return Pt.get(e)}function _t(e,t,s,a){if(Vt.has(e)){const n=Vt.get(e);switch(t){case"m":n.multiplier=[s,a];break;case"Œµ":n.eccentricity=[s,a];break;case"ùóå":n.sensitivity=[s,a];break;case"Œ∏":n.rotation=[s,a];break;case"a":n.amplitude=[s,a];break;case"Œ¥x":n.shiftx=[s,a];break;case"Œ¥y":n.shifty=[s,a];break;case"Œ¶":n.phase=[s,a];break;case"shape":n.shape=[s,a]}}if(Pt.has(e)){const a=Ut(e);switch(!0){case"on"===t:a.on=s;break;case"frequency"===t:a.frequency=s;break;case"range"===t:a.range=s;break;case"plug"===t:a.plug=Rt(s)}}}function Wt(){const e=[...Pt.entries()].map((([e,t])=>[e,Rt(t.plug)]));return new Map(e)}function Yt(){const e={SNs:[...Vt.values()].map((e=>e.serialise())),LFOs:[...Pt.values()].map((e=>e.serialise()))};_("LFOs",e)}const zt=new class{constructor(){this.internal={context:null,recorder:null,song:"snyth",onAvailable:null,recording:!1},this.audio=[],this.blob=null}initialise(e,...t){this.internal.context=e,this.internal.stream=e.createMediaStreamDestination(),this.internal.recorder=new MediaRecorder(this.internal.stream.stream);for(const e of t)e.connect(this.internal.stream);this.internal.recorder.ondataavailable=e=>{this.audio.push(e.data)},this.internal.recorder.onstop=e=>{const t=new Blob(this.audio,{type:"audio/ogg; codecs=opus"});this.blob=t,null!=this.internal.onAvailable&&this.internal.onAvailable(t,this.song)}}get song(){return this.internal.song}set song(e){this.internal.song=e}get recording(){return this.internal.recording}get paused(){return!!this.internal.recorder&&"paused"===this.internal.recorder.state}start(){this.audio=[],this.blob=null,this.reset(),this.internal.recorder&&(this.paused?this.internal.recorder.resume():this.internal.recorder.start(),this.internal.recording=!0)}stop(){this.internal.recorder&&this.internal.recorder.stop(),this.internal.recording=!1}pause(){this.internal.recorder&&this.recording&&this.internal.recorder.pause()}resume(){this.internal.recorder&&this.internal.recorder.start()}reset(){this.audio=[],this.blob=null,null!=this.internal.onAvailable&&this.internal.onAvailable(null,"")}set onavailable(e){this.internal.onAvailable=e}};let It,Ht=null,Jt=null,Kt=null,Qt=null,Xt=null,Zt=null,es=null,ts=null,ss=null;function as(e){const t=is(e,0,1);null!=ts&&(ts.gain.value=t),ls("changed",z.synth,V.synth.settings.volume,t)}function ns(e){const t=is(e,0,1);if(It&&Ht){Ht.parameters.get("gain").setValueAtTime(t,It.currentTime)}if(It&&Jt){Jt.parameters.get("gain").setValueAtTime(t,It.currentTime)}ls("changed",z.synth,V.synth.settings.gain,t)}function is(e,t,s){return Math.min(Math.max(e,t),s)}function ls(e,t,s,a){const n=new CustomEvent(e,{detail:{oid:t+s,value:a}});Y(n)}const os=new class{constructor(){this.genfn=document.querySelector("#LFO snyth-genfn"),this.waveform=document.querySelector("#LFO snyth-waveform"),this.controlsets=[document.querySelector('#LFO .controlset[tag="sn.R"]'),document.querySelector('#LFO .controlset[tag="sn.G"]'),document.querySelector('#LFO .controlset[tag="sn.B"]')],this.switches=[document.querySelector('#LFO .switches snyth-togglebutton[tag="lfo.1"]'),document.querySelector('#LFO .switches snyth-togglebutton[tag="lfo.2"]'),document.querySelector('#LFO .switches snyth-togglebutton[tag="lfo.3"]'),document.querySelector('#LFO .switches snyth-togglebutton[tag="lfo.4"]')],this.frequencies=[document.querySelector('#LFO .frequencies snyth-lfo-frequency[tag="lfo.1"]'),document.querySelector('#LFO .frequencies snyth-lfo-frequency[tag="lfo.2"]'),document.querySelector('#LFO .frequencies snyth-lfo-frequency[tag="lfo.3"]'),document.querySelector('#LFO .frequencies snyth-lfo-frequency[tag="lfo.4"]')],this.ranges=[document.querySelector('#LFO .ranges snyth-minmax[tag="lfo.1"]'),document.querySelector('#LFO .ranges snyth-minmax[tag="lfo.2"]'),document.querySelector('#LFO .ranges snyth-minmax[tag="lfo.3"]'),document.querySelector('#LFO .ranges snyth-minmax[tag="lfo.4"]')],this.patchbay=document.querySelector("#LFO .patch-panel"),this.scale=1}initialise(){this.controlsets[0].defaults=rs.controlsets[0].asObject(),this.controlsets[1].defaults=rs.controlsets[1].asObject(),this.controlsets[2].defaults=rs.controlsets[2].asObject(),this.controlsets[0].values=cs.controlsets[0].asObject(),this.controlsets[1].values=cs.controlsets[1].asObject(),this.controlsets[2].values=cs.controlsets[2].asObject(),this.controlsets[0].values=Bt.asObject(),this.controlsets[1].values=jt.asObject(),this.controlsets[2].values=Dt.asObject(),this.switches.forEach((e=>{e.state=Ut(e.tag).on?"on":"off"})),this.frequencies.forEach((e=>{e.value=Ut(e.tag).frequency})),this.ranges.forEach((e=>{e.value=Ut(e.tag).range})),this.patchbay.initialise(Wt()),this.switches.forEach((e=>{this.patchbay.on(e.tag,"on"===e.state)})),this.controlsets.forEach((e=>{e.onchange=(e,t,s)=>{_t(e,t,s,"change")},e.onchanged=(e,t,s)=>{_t(e,t,s,"changed")}})),this.switches.forEach((e=>{e.onchanged=(e,t)=>{_t(e,"on","on"===t,"changed"),this.patchbay.on(e,"on"===t)}})),this.frequencies.forEach((e=>{e.onchange=(e,t)=>{_t(e,"frequency",t,"change")},e.onchanged=(e,t)=>{_t(e,"frequency",t,"changed")}})),this.ranges.forEach((e=>{e.onchange=(e,t)=>{_t(e,"range",t,"change")},e.onchanged=(e,t)=>{_t(e,"range",t,"changed")}})),this.patchbay.onchanged=(e,t)=>{_t(e,"plug",t,"changed")},ae("changed",(e=>{this.reinitialise(),this.redraw(),Yt()}),le.SN.LFO),ae("changed",(e=>{this.reinitialise(),Yt()}),le.LFO.any),this.redraw()}reinitialise(){this.controlsets[0].values=Bt.asObject(),this.controlsets[1].values=jt.asObject(),this.controlsets[2].values=Dt.asObject(),this.switches.forEach((e=>{e.state=Ut(e.tag).on?"on":"off"})),this.frequencies.forEach((e=>{e.value=Ut(e.tag).frequency})),this.ranges.forEach((e=>{e.value=Ut(e.tag).range})),this.patchbay.initialise(Wt()),this.switches.forEach((e=>{this.patchbay.on(e.tag,"on"===e.state)}))}redraw(){!function(e,t,s,a){const n=ne(s),i=ie(s).map((e=>e.map((e=>function(e,t,s){return Math.min(Math.max(e,t),s)}(e,-1,1)))));e.redraw(n,hs,a),t.redraw(i,hs,a)}(this.genfn,this.waveform,(this.controlsets,[Bt,jt,Dt].map((e=>new R({m:e.multiplier,e:e.eccentricity,s:e.sensitivity,"Œ∏":e.rotation,h:e.amplitude,"Œ¥x":e.shiftx,"Œ¥y":e.shifty,"Œ¶":e.phase,"ùúì":0,balance:0,shape:e.shape})))),this.scale)}};const rs={controlsets:[new R({m:1,e:0,s:10,"Œ∏":0,h:1,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:2,e:0,s:10,"Œ∏":0,h:0,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:4,e:0,s:10,"Œ∏":0,h:0,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"})]},cs={controlsets:[new R({m:1,e:0,s:10,"Œ∏":0,h:.5,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:2,e:0,s:10,"Œ∏":0,h:.3,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:4,e:0,s:10,"Œ∏":0,h:.2,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"})]},hs=[{base:"#ff0000",visibility:1,colours:[{colour:"#ff000030",width:10},{colour:"#ff000050",width:4},{colour:"#ff000090",width:2}]},{base:"#00c000",visibility:1,colours:[{colour:"#00c00030",width:10},{colour:"#00c00050",width:4},{colour:"#00c00090",width:2}]},{base:"#4040ff",visibility:1,colours:[{colour:"#4040ff30",width:10},{colour:"#4040ff50",width:4},{colour:"#4040ff90",width:2}]},{base:"#ffb300",visibility:1,colours:[{colour:"#ffb30040",width:10},{colour:"#ffb30080",width:4},{colour:"#ffb300ff",width:2}]}];const us=new class{constructor(){this.genfn=document.querySelector("#OSC #osc-genfn"),this.waveform=document.querySelector("#OSC #osc-waveform"),this.fft=document.querySelector("#OSC #osc-fft"),this.controlsets=[document.querySelector('#OSC .controlset[tag="sn.R"]'),document.querySelector('#OSC .controlset[tag="sn.G"]'),document.querySelector('#OSC .controlset[tag="sn.B"]')],this.traces={red:document.querySelector('#OSC div.traces snyth-pushbutton[tag="trace.1"]'),green:document.querySelector('#OSC div.traces snyth-pushbutton[tag="trace.2"]'),blue:document.querySelector('#OSC div.traces snyth-pushbutton[tag="trace.3"]'),yellow:document.querySelector('#OSC div.traces snyth-pushbutton[tag="trace.4"]')},this.internal={zoom:document.querySelector("#osc-zoom"),animate:document.querySelector("#osc-animate")},this.scale=1}get animate(){return this.internal.animate.checked}get parameters(){return wt()}initialise(){this.controlsets[0].defaults=fs.controlsets[0].asObject(),this.controlsets[1].defaults=fs.controlsets[1].asObject(),this.controlsets[2].defaults=fs.controlsets[2].asObject(),this.controlsets[0].values=ms.controlsets[0].asObject(),this.controlsets[1].values=ms.controlsets[1].asObject(),this.controlsets[2].values=ms.controlsets[2].asObject(),this.controlsets.forEach((e=>{e.onchange=(e,t,s)=>{At(e,t,s,"change")},e.onchanged=(e,t,s)=>{At(e,t,s,"changed")}})),this.traces.red.onclick=e=>{this.toggle(1)},this.traces.green.onclick=e=>{this.toggle(2)},this.traces.blue.onclick=e=>{this.toggle(3)},this.traces.yellow.onclick=e=>{this.toggle(4)},this.internal.zoom.onchanged=e=>{this.zoom(e)},ae("changed",(e=>{this.controlsets[0].values=gt.asObject(),this.controlsets[1].values=vt.asObject(),this.controlsets[2].values=$t.asObject(),this.redraw()}),le.SN.OSC),this.redraw()}reset(){this.controlsets.forEach((e=>e.reset()))}zoom(e){this.scale=e,this.redraw()}toggle(e){const t=ys[e-1],s=t.base,a=ds.get(t.visibility),n=ps.get(a);t.visibility=a,t.colours[0].colour=`${s}${n[0]}`,t.colours[1].colour=`${s}${n[1]}`,t.colours[2].colour=`${s}${n[2]}`,this.redraw()}redraw(e){const t=this.parameters;if(null!=e&&this.animate)for(let s=0;s<3;s++)t[s].e*=e[Ft[s]],t[s].s*=e[Mt[s]],t[s].Œ∏*=e[Ct[s]],t[s].h*=e[Tt[s]],t[s].h*=e[Tt[s]],t[s].Œ¥x*=e[Gt[s]],t[s].Œ¥y*=e[Lt[s]];const s=ne(t),a=ie(t);this.genfn.redraw(s,ys,this.scale),this.waveform.redraw(a,ys,this.scale),this.fft.fft=oe(t)}},ds=new Map([[0,.25],[.25,1],[.5,0],[1,.5]]),ps=new Map([[0,["00","00","00"]],[.25,["10","20","40"]],[.5,["20","40","80"]],[1,["40","80","ff"]]]),ys=[{base:"#ff0000",visibility:1,colours:[{colour:"#ff000040",width:10},{colour:"#ff000080",width:4},{colour:"#ff0000ff",width:2}]},{base:"#00c000",visibility:1,colours:[{colour:"#00c00040",width:10},{colour:"#00c00080",width:4},{colour:"#00c000ff",width:2}]},{base:"#4040ff",visibility:1,colours:[{colour:"#4040ff40",width:10},{colour:"#4040ff80",width:4},{colour:"#4040ffff",width:2}]},{base:"#ffff00",visibility:1,colours:[{colour:"#ffff0040",width:10},{colour:"#ffff0080",width:4},{colour:"#ffff00ff",width:2}]}],fs={controlsets:[new R({m:1,e:0,s:10,"Œ∏":0,h:1,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:2,e:0,s:10,"Œ∏":0,h:0,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:4,e:0,s:10,"Œ∏":0,h:0,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"})]},ms={controlsets:[new R({m:1,e:.1,s:10,"Œ∏":30,h:.7,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:2,e:0,s:10,"Œ∏":0,h:.5,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"}),new R({m:4,e:0,s:10,"Œ∏":0,h:.3,"Œ¶":0,balance:0,"ùúì":0,"Œ¥x":0,"Œ¥y":0,shape:"ellipse"})]};const gs=new class{constructor(){const e=document.querySelector("div#envelopes");this.envelopes=e.querySelectorAll("div.grid snyth-envelope"),this.editor=e.querySelector(".editor"),this.values=e.querySelector(".values"),this.text=e.querySelector(".description"),re(),Array.from(ce).forEach((e=>{this.restyle(`${e.oid}`),this.relabel(`${e.oid}${V.envelope.label}`,e.label),this.favourite(`${e.oid}${V.envelope.favourite}`,e.favourite)})),this.internal={animate:document.querySelector("#env-animate")}}get animate(){return null!=this.envelope&&this.internal.animate.checked}initialise(){for(const e of this.envelopes)e.onclick=t=>{t.altKey?t.currentTarget.classList.contains("favourite")?he(e.value,!1):he(e.value,!0):t.ctrlKey?ue(e.value):de(e.value)},e.oncontextmenu=t=>{t.preventDefault(),ue(e.value)};this.envelope=null,ae("change",(e=>this.refresh(e.detail.oid,"editing")),le.envelopes.any),ae("changed",(e=>this.relabel(e.detail.oid,e.detail.value)),le.envelopes.label),ae("changed",(e=>this.favourite(e.detail.oid,e.detail.value)),le.envelopes.favourite),ae("changed",(e=>{fe(),this.refresh(e.detail.oid,""),this.restyle(e.detail.oid)}),le.envelopes.any),ae("changed",(e=>{Array.from(this.envelopes).filter((t=>P.matches(t.value,e.detail.value))).forEach((e=>{e.selected=!0})),Array.from(this.envelopes).filter((t=>!P.matches(t.value,e.detail.value))).forEach((e=>{e.selected=!1})),this.edit(e.detail.value)}),le.synth.envelope)}restyle(e){const t=pe(e);t&&t.edited&&Array.from(this.envelopes).filter((t=>P.contains(e,t.value))).forEach((e=>{e.edited=!0})),t&&!t.edited&&Array.from(this.envelopes).filter((t=>P.contains(e,t.value))).forEach((e=>{e.edited=!1}))}relabel(e,t){Array.from(this.envelopes).filter((t=>P.contains(e,t.value))).forEach((e=>{e.label=t}))}favourite(e,t){t&&Array.from(this.envelopes).filter((t=>e.startsWith(`${t.value}.`))).forEach((e=>{e.favourite=!0})),t||Array.from(this.envelopes).filter((t=>e.startsWith(`${t.value}.`))).forEach((e=>{e.favourite=!1}))}redraw(e){const t=this.envelope;if(null!=e&&this.animate){const s=t.attack*e[St],a="AR"===t.type?0:this.envelope.decay*e[kt],n="AR"===t.type?1:this.envelope.sustain*e[Ot],i=t.release*e[Et];this.editor.animate({attack:s,decay:a,sustain:n,release:i})}else this.editor.animate(null)}refresh(e,t){if(this.envelope&&e.startsWith(this.envelope.oid)){this.editor.redraw(t);const e=this.envelope.inflections(),s=this.text.querySelector("input#envelope-tag"),a=this.text.querySelector("input#envelope-text");s.value=this.envelope.label,a.value=this.envelope.text,e.attack.forEach((e=>{this.values.querySelector(`snyth-range-ms[data-id="${e.tag}"]`).value=e.value})),e.sustain.forEach((e=>{this.values.querySelector(`snyth-range-float[data-id="${e.tag}"]`).value=e.value})),e.release.forEach((e=>{this.values.querySelector(`snyth-range-ms[data-id="${e.tag}"]`).value=e.value}))}}edit(e){const t=pe(e),s=this.editor,a=this.text.querySelector("input#envelope-tag"),n=this.text.querySelector("input#envelope-text");if(e===ye.oid)this.clear();else if(t){this.envelope=t,s.edit(t),a.value=t.label,n.value=t.text,s.onchange=e=>{t.update(e.detail.tag,null,e.detail.at,e.detail.level)},s.onchanged=e=>{t.commit(e.detail.tag,null,e.detail.at,e.detail.level)},a.oninput=e=>{t.label=a.value},n.oninput=e=>{t.text=n.value},this.values.querySelectorAll("snyth-range-ms").forEach((e=>{e.classList.remove("visible"),e.value="",e.enabled=!1})),this.values.querySelectorAll("snyth-range-float").forEach((e=>{e.classList.remove("visible"),e.value="",e.enabled=!1}));const e=t.inflections();for(const s of e.attack){const e=this.values.querySelector(`snyth-range-ms[data-id="${s.tag}"]`);e&&(e.enabled=!0,e.dataset.tag=s.tag,e.value=s.value,e.classList.add("visible"),e.onChange=e=>t.update(s.tag,e,null,null),e.onChanged=e=>t.commit(s.tag,e,null,null))}for(const s of e.sustain){const e=this.values.querySelector(`snyth-range-float[data-id="${s.tag}"]`);e&&(e.enabled=!0,e.dataset.tag=s.tag,e.value=s.value,e.classList.add("visible"),e.onChange=e=>t.update(s.tag,e,null,null),e.onChanged=e=>t.commit(s.tag,e,null,null))}for(const s of e.release){const e=this.values.querySelector(`snyth-range-ms[data-id="${s.tag}"]`);e&&(e.enabled=!0,e.dataset.tag=s.tag,e.value=s.value,e.classList.add("visible"),e.onChange=e=>t.update(s.tag,e,null,null),e.onChanged=e=>t.commit(s.tag,e,null,null))}if("AR"===t.type){const e=this.values.querySelector('snyth-range-ms[data-id="A"]'),t=this.values.querySelector('snyth-range-ms[data-id="D"]'),s=this.values.querySelector('snyth-range-float[data-id="S"]'),a=this.values.querySelector('snyth-range-ms[data-id="R"]');e.style.gridRow="1 / span 1",a.style.gridRow="2 / span 1",t.style.gridRow="3 / span 1",s.style.gridRow="4 / span 1"}if("ADSR"===t.type){const e=this.values.querySelector('snyth-range-ms[data-id="A"]'),t=this.values.querySelector('snyth-range-ms[data-id="D"]'),s=this.values.querySelector('snyth-range-float[data-id="S"]'),a=this.values.querySelector('snyth-range-ms[data-id="R"]');e.style.gridRow="1 / span 1",t.style.gridRow="2 / span 1",s.style.gridRow="3 / span 1",a.style.gridRow="4 / span 1"}}}clear(){const e=this.editor,t=this.text.querySelector("input#envelope-tag"),s=this.text.querySelector("input#envelope-text");e.edit(null),t.value="",s.value="",this.values.querySelectorAll("snyth-range-ms").forEach((e=>{e.classList.remove("visible"),e.value="",e.enabled=!1})),this.values.querySelectorAll("snyth-range-float").forEach((e=>{e.classList.remove("visible"),e.value="",e.enabled=!1}))}},vs=2*Math.PI,$s=1500;let bs=0;const ws=new class{constructor(e){this.oid=e,this.powerOn=!1,this.notes=[],this.stale={OSC:!0,ENV:!0,LFO:!0},document.querySelector("#reset").onclick=e=>this.reset(e),document.querySelector("#stop").onclick=e=>this.stop(e),this.internal={stopped:!0,volume:document.querySelector("#volume"),gain:document.querySelector("#gain"),mode:document.querySelector("#worklets"),progressBar:document.querySelector("#progressbar"),play:document.querySelector("#play"),envelope:document.querySelector("#envelope"),load:document.querySelector("#load"),reset:document.querySelector("#reset"),record:document.querySelector("#record"),picker:document.querySelector("#midi"),AA:document.querySelector("#osc-aa")}}get picker(){return this.internal.picker}get volume(){const e=this.internal.volume.value,t=this.internal.volume.min;return(e-t)/(this.internal.volume.max-t)}set volume(e){const t=parseFloat(e);Number.isNaN(t)||(this.internal.volume.value=Cs(t,0,1))}get gain(){const e=this.internal.gain.value,t=this.internal.gain.min;return(e-t)/(this.internal.gain.max-t)}set gain(e){const t=parseFloat(e);Number.isNaN(t)||(this.internal.gain.value=Cs(t,0,1))}get envelope(){return this.internal.envelope.value}set title(e){this.picker.title=e}set progress(e){this.picker.progress=e}set duration(e){this.picker.duration=e}get playing(){return this.internal.play.playing}set playing(e){this.internal.play.playing=e}get recording(){return this.internal.record.recording}get looping(){return!this.internal.stopped&&this.internal.play.loop}get autoload(){return this.internal.load.autoLoad}get antialias(){return this.internal.AA.checked}initialise(){!function(){(function(){try{const e=W("LFOs");if(null!=e){const t=new Map([...Pt.values(),...Vt.values()].map((e=>[e.oid,e])));if(Object.hasOwn(e,"SNs"))for(const s of e.SNs)t.has(s.oid)&&t.get(s.oid).deserialise(s);if(Object.hasOwn(e,"LFOs"))for(const s of e.LFOs)t.has(s.oid)&&t.get(s.oid).deserialise(s)}}catch(e){console.error(e)}})(),function(){const e=new Map([...st].map((e=>[e.oid,e])));try{const t=W("playlist");if(null!=t&&Object.hasOwn(t,"slots"))for(const s of t.slots)if(e.has(s.oid)&&""!==s.url){const t=e.get(s.oid);t.url=s.url,t.title=s.title,t.data=new Uint8Array(s.data)}}catch(e){console.error(e)}}();for(const e of st)""!==e.url&&ws.stashed(e.oid,e.url,e.title)}(),function(e){e.picker.onPicked=Ss,e.picker.onPlaylist=ks,e.picker.onUnqueue=()=>{ot(D)},e.internal.mode.onChanged=e=>{!function(e){const t=function(e,t){const s=e.parameters.get("volume");s.cancelScheduledValues(0),s.linearRampToValueAtTime(t,It.currentTime+2.5)};switch(e){case"wavetable":t(Ht,1),t(Jt,1e-4),es=Ht;break;case"DDS":t(Ht,1e-4),t(Jt,1),es=Jt}}(e.currentTarget.value)},e.internal.gain.onChange=t=>{ns(e.gain)},e.internal.volume.onChange=t=>{as(e.volume)},e.internal.envelope.onClick=t=>{!function(e){let t=ge(e),s=0;for(;!t.favourite&&s<=13;)t=ge(t.oid),s++;de(t.oid)}(e.envelope)},e.internal.AA.onchange=t=>{var s;s=e.antialias,ss&&(s?ss.frequency.exponentialRampToValueAtTime(8192,It.currentTime+.25):ss.frequency.exponentialRampToValueAtTime(22050,It.currentTime+.25))}}(this),function(e){ae("change",(t=>{e.stale.OSC=!0}),le.SN.OSC),ae("changed",(t=>{e.autoload?Os():e.stale.OSC=!0,Es()}),le.SN.OSC),ae("change",(t=>{e.stale.ENV=!0}),le.envelopes.any),ae("changed",(t=>{const s=ve();e.internal.envelope.value=s.oid,e.internal.envelope.label=s.label,Fs(s.oid),e.autoLoad&&Os()}),le.synth.envelope),ae("changed",(t=>{const s=ve();e.internal.envelope.label=s.label,Fs(s.oid),e.autoLoad&&Os()}),le.envelopes.any),ae("change",(t=>{e.stale.LFO=!0}),le.SN.LFO),ae("changed",(t=>{e.stale.LFO=!0}),le.SN.LFO),ae("changed",(e=>function(e,t){const s=P.contains(e,`${Z}`)?Z:P.contains(e,`${ee}`)?ee:P.contains(e,`${te}`)?te:P.contains(e,`${se}`)?se:"???",a=P.contains(e,`${Z}`)?"lfo.1":P.contains(e,`${ee}`)?"lfo.2":P.contains(e,`${te}`)?"lfo.3":P.contains(e,`${se}`)?"lfo.4":null,n=P.contains(e,`${Z}`)?Kt:P.contains(e,`${ee}`)?Qt:P.contains(e,`${te}`)?Xt:P.contains(e,`${se}`)?Zt:null;if(null==n)return;switch(!0){case P.matches(e,`${s}${V.lfo.on}`):n.parameters.get("on").linearRampToValueAtTime(!0===t?1:0,It.currentTime+.5);break;case P.matches(e,`${s}${V.lfo.frequency}`):n.parameters.get("frequency").exponentialRampToValueAtTime(parseFloat(t),It.currentTime+.1);break;case P.matches(e,`${s}${V.lfo.range.min}`):n.parameters.get("min").linearRampToValueAtTime(parseFloat(t),It.currentTime+.1);break;case P.matches(e,`${s}${V.lfo.range.max}`):n.parameters.get("max").linearRampToValueAtTime(parseFloat(t),It.currentTime+.1);break;case P.matches(e,`${s}${V.lfo.plug}`):Ht.patch(a,t),Jt.patch(a,t);break;default:console.error("unsupported LFO parameter",e)}}(e.detail.oid,e.detail.value)),le.LFO.any);const t=function(){e.powerOn&&null!=Ht&&Ht.regenerate(),Ns(),window.requestAnimationFrame(t)};window.requestAnimationFrame(t)}(this),function(e){ae("changed",(t=>{e.queued(D,"queued"===t.detail.value)}),le.playlist.song.state),ae("changed",(t=>{const s=t.detail.oid.match(/^(0\.5\.1\.[0-9]+)\..*$/);if(null!=s){const a=s[1];"queued"===t.detail.value?e.queued(a,!0):"dequeued"===t.detail.value?e.queued(a,!1):"error"===t.detail.value&&e.picker.error(a,!0)}}),le.playlist.slot.state),ae("changed",(t=>{const s=t.detail.oid.match(/^(0\.5\.1\.[0-9]+)\..*$/);null!=s&&e.stashed(s[1],t.detail.value.url,t.detail.value.title)}),le.playlist.slot.url)}(this)}onPowerUp(e,t){this.internal.mode.enabled=!0,this.internal.mode.selected="wavetable",this.internal.record.enabled=!0,function(e,t){(function(e,t){It=e,Ht=t.get("wavetable"),Jt=t.get("dds"),es=Ht,Kt=t.get("lfo.1"),Qt=t.get("lfo.2"),Xt=t.get("lfo.3"),Zt=t.get("lfo.4"),ss=e.createBiquadFilter(),ss.type="lowpass",ss.Q.setValueAtTime(1,e.currentTime),ss.gain.setValueAtTime(0,e.currentTime),ss.frequency.setValueAtTime(22050,e.currentTime),ts=new GainNode(e),Ht.connect(ss),Jt.connect(ss),ss.connect(ts),ts.connect(e.destination),Ht.parameters.get("volume").setValueAtTime(1,e.currentTime),Jt.parameters.get("volume").setValueAtTime(1e-4,e.currentTime),Kt.connect(Ht.parameters.get("lfo1")),Qt.connect(Ht.parameters.get("lfo2")),Xt.connect(Ht.parameters.get("lfo3")),Zt.connect(Ht.parameters.get("lfo4")),Kt.connect(Jt.parameters.get("lfo1")),Qt.connect(Jt.parameters.get("lfo2")),Xt.connect(Jt.parameters.get("lfo3")),Zt.connect(Jt.parameters.get("lfo4")),zt.initialise(e,ss),new Map([["lfo.1",Kt],["lfo.2",Qt],["lfo.3",Xt],["lfo.4",Zt]]).forEach(((t,s)=>{const a=Ut(s),n=!0===a.on?1:0,i=Math.max(a.frequency,.1),l=a.range,o=a.plug,r=e.currentTime+.1;t.parameters.get("on").linearRampToValueAtTime(n,r),t.parameters.get("frequency").exponentialRampToValueAtTime(i,r),t.parameters.get("min").linearRampToValueAtTime(l.min,r),t.parameters.get("max").linearRampToValueAtTime(l.max,r),Ht.patch(s,o),Jt.patch(s,o)}))})(e,t),zt.onavailable=(e,t)=>{ws.internal.record.recorded={title:t,blob:e}},as(ws.volume),ns(ws.gain),Array.from(["#stop"]).forEach((e=>{document.querySelector(e).disabled=!1})),ws.internal.play.onPlay=xs,ws.internal.play.onPause=qs,ws.internal.load.onLoad=Os,ws.internal.play.disabled=!1,ws.internal.envelope.disabled=!1,ws.internal.load.disabled=!1,ws.internal.gain.level=0,ws.internal.gain.clipping=0,ws.internal.volume.level=1,ws.internal.volume.dropping=0,Os(),Es(),ws.stale.OSC=!0,ws.stale.ENV=!0,ws.stale.LFO=!0}(e,t),this.powerOn=!0}onPowerDown(){this.powerOn=!1,this.internal.mode.enabled=!1,this.internal.record.enabled=!1,function(e){document.querySelector("div#buttons").dataset.state="",Array.from(["#stop"]).forEach((e=>{document.querySelector(e).disabled=!0})),e.internal.play.disabled=!0,e.internal.load.disabled=!0,e.internal.envelope.disabled=!0,e.internal.gain.level=0,e.internal.gain.clipping=0,e.internal.volume.level=1,e.internal.volume.dropping=0,As.reset()}(this)}prepare(e,t,s,a){this.notes=s,bs=0,s&&s.length>0?document.querySelector("div#buttons").dataset.midi="ready":document.querySelector("div#buttons").dataset.midi="",s&&s.length>0?(this.progress=0,this.duration=Math.max(...s.map((e=>e.end)))):(this.progress=0,this.duration=0),""!==t?(this.title=Gs(t),zt.song=t):(this.title=Gs(e,"start"),zt.song=t),at.current={name:t,file:e,notes:s,data:a},Ts("changed",`${z.playlist}`,V.playlist.song.title,t),Ts("changed",`${z.playlist}`,V.playlist.song.file,e),this.stop()}enqueue(e,t,s,a,n){!function(e,t,s,a,n){!0===P.matches(e,U)?(nt.set(e,{oid:e,file:t,title:s,notes:a,data:n}),pt(`${e}${V.playlist.slot.state}`,"queued")):(it++,nt.set(`${D}${V.playlist.song.queueid}.${it}`,{oid:`${D}${V.playlist.song.queueid}.${it}`,file:t,title:s,notes:a,data:n}),pt(`${D}${V.playlist.song.state}`,"queued"))}(e,t,s,a,n)}queued(e,t){this.picker.queued(e,!0===t)}stashed(e,t,s){this.picker.stashed(e,t,s)}play(e,t,s,a){this.prepare(e,t,s,a),xs()}reset(e){gt.reset({m:1,"Œµ":0,"ùóå":10,"Œ∏":0,a:1,"Œ¥x":0,"Œ¥y":0,"Œ¶":0,"ùúì":0,b:0,shape:"ellipse"}),vt.reset({m:2,"Œµ":0,"ùóå":10,"Œ∏":0,a:0,"Œ¥x":0,"Œ¥y":0,"Œ¶":0,"ùúì":0,b:0,shape:"ellipse"}),$t.reset({m:4,"Œµ":0,"ùóå":10,"Œ∏":0,a:0,"Œ¥x":0,"Œ¥y":0,"Œ¶":0,"ùúì":0,b:0,shape:"ellipse"}),us.reset(),de(ye.oid),setTimeout((()=>{us.redraw(),Os(),Es(),ws.internal.reset.classList.remove("highlight")}),50)}stop(){this.internal.stopped=!0,this.playing=!1,As.reset(),Ht&&Ht.stop(),Jt&&Jt.stop(),zt.stop()}}(me),As=new class{constructor(e,t,s){this.id=e,this.keyboard=document.querySelector(`${e} div`),this.noteOn=t,this.noteOff=s;et.forEach(((e,t)=>{const s=document.createElement("div");s.className="octave",e.forEach((e=>{1===e.length&&s.appendChild(function(e,t){const s=document.createElement("div"),a=document.createElement("div");return a.innerHTML=`${e}<sub>${t}</sub>`,s.className="key",s.dataset.note=`${e}${t}`,s.appendChild(a),s}(e,t))})),this.keyboard.appendChild(s)})),this.keyboard.addEventListener("mousedown",(e=>this.onMouseDown(e)),!0),this.keyboard.addEventListener("mouseup",(e=>this.onMouseUp(e)),!0),this.keyboard.addEventListener("contextmenu",(e=>this.onRightClick(e)),!1)}reset(){this.keyboard.querySelectorAll("div.key").forEach((e=>{const t=e.dataset;t.note&&this.noteOff&&this.noteOff(e.dataset.note)&&delete t.pressed}))}onMouseDown(e){if(e.preventDefault(),0===e.button&&e.target.classList.contains("key")){const t=e.target.dataset;t.pressed&&"yes"===t.pressed||t.note&&this.noteOn&&this.noteOn(e.target.dataset.note)&&(t.pressed="yes")}return!1}onMouseUp(e){if(e.preventDefault(),0===e.button&&e.target.classList.contains("key")){const t=e.target.dataset;t.note&&this.noteOff&&this.noteOff(e.target.dataset.note)&&delete t.pressed}return!1}onRightClick(e){if(e.preventDefault(),e.target.classList.contains("key")){const t=e.target.dataset;t.pressed&&"yes"===t.pressed?t.note&&this.noteOff&&this.noteOff(e.target.dataset.note)&&delete t.pressed:t.note&&this.noteOn&&this.noteOn(e.target.dataset.note)&&(t.pressed="yes")}return!1}}("#keyboard",(function(e){let t=!1;return Ht&&(Ht.keyPressed(`${e}`),t=!0),Jt&&(Jt.keyPressed(`${e}`),t=!0),t}),(function(e){let t=!1;return Ht&&(Ht.keyReleased(`${e}`),t=!0),Jt&&(Jt.keyReleased(`${e}`),t=!0),t}));function xs(){var e,t;ws.internal.stopped=!1,e=ws.notes,t=ws.recording,Ht.play(e),Jt.play(e),t&&zt.start()}function qs(){Ht.pause(),Jt.pause(),zt.pause()}function Ns(){null==Ns.animate&&(Ns.animate={OSC:!1,ENV:!1});const e=null!=es?es.patchbay:null,t={OSC:null!=e&&us.animate,ENV:null!=e&&gs.animate};if((ws.stale.OSC||t.OSC||Ns.animate.OSC)&&(us.redraw(e),Ns.animate.OSC=t.OSC),(ws.stale.ENV||t.ENV||Ns.animate.ENV)&&(gs.redraw(e),Ns.animate.ENV=t.ENV),ws.stale.OSC&&(Es(),ws.stale.OSC=!1,ws.internal.load.highlight=!0,ws.internal.reset.classList.add("highlight")),ws.stale.ENV&&(Es(),ws.stale.ENV=!1,ws.internal.load.highlight=!0),ws.stale.LFO){ws.stale.LFO=!1,os.redraw();const e=[Bt,jt,Dt].map((e=>({m:e.multiplier,e:e.eccentricity,s:e.sensitivity,"Œ∏":e.rotation,h:e.amplitude,"Œ¶":e.phase,"ùúì":0,"Œ¥x":e.shiftx,"Œ¥y":e.shifty,shape:e.shape}))),t=e.map((({m:e,e:t,s:s,"Œ∏":a,h:n,"Œ¶":i,"ùúì":l,"Œ¥x":o,"Œ¥y":r,shape:c})=>({m:e,e:t,s:s,"Œ∏":Ms(a),h:1,"Œ¶":Ms(i),"ùúì":0,"Œ¥x":o,"Œ¥y":r,shape:c}))).map((e=>xe(e,720))),s=t.map(((t,s)=>t.map((t=>e[s].h*t)))).reduce(((e,t)=>t.map(((t,s)=>t+e[s])))).map((e=>Cs(e,-1,1)));null!=Kt&&Kt.load(s),null!=Qt&&Qt.load(t[0]),null!=Xt&&Xt.load(t[1]),null!=Zt&&Zt.load(t[2])}if(ws.powerOn&&es){const e=es.metrics;if(!Number.isNaN(e.volume)){const e=Ht.metrics.volume,t=Jt.metrics.volume;ws.internal.volume.level=e+t}Number.isNaN(e.level)||(ws.internal.gain.level=e.level),Number.isNaN(e.clipping)||(ws.internal.gain.clipping=1*e.clipping),Number.isNaN(e.dropping)||(ws.internal.volume.dropping=1*e.dropping),e.maxNotes>bs&&(bs=e.maxNotes,console.log(`notes:${e.notes} max:${bs}`)),ws.progress=e.duration}if(ws.powerOn&&es){const e=document.querySelector("div#buttons");if("playing"!==e.dataset.state&&null!=es&&"playing"===es.state)ws.playing=!0,e.dataset.state="playing";else if("paused"!==e.dataset.state&&null!=es&&"paused"===es.state)ws.playing=!1,e.dataset.state="paused";else if("stopped"!==e.dataset.state&&null!=es&&"stopped"===es.state)if(e.dataset.state="stopped",ws.looping)setTimeout(xs,50);else{ws.playing=!1,zt.stop();const e=function(){const e=[...nt.keys()];if(e.length>0){const t=e.shift(),s=nt.get(t);return nt.delete(t),P.contains(s.oid,D)?null==e.find((e=>P.contains(e,D)))&&pt(`${D}${V.playlist.song.state}`,"dequeued"):pt(`${s.oid}${V.playlist.slot.state}`,"dequeued"),s}return null}();null!=e&&setTimeout((t=>{ws.play(e.file,e.title,e.notes,e.data)}),$s)}ws.playing&&ws.recording&&!zt.recording?zt.start():ws.playing&&!ws.recording&&zt.recording&&zt.stop()}}function Ss(e,t){e.arrayBuffer().then((s=>(s=>{const a=Qe(Ke(s)),n=new Uint8Array(s);"queue"===t?ws.enqueue(D,e.name,a.name,a.notes,n):ws.prepare(e.name,a.name,a.notes,n)})(s))).catch((e=>{console.error(e)}))}function ks(e,t,s){"play"===e&&lt(t,s).then((e=>ws.prepare(e.file,e.name,e.notes,e.data))).catch((e=>{console.log(e)})),"queue"===e&&lt(t).then((e=>ws.enqueue(t,e.file,e.name,e.notes,e.data))).catch((e=>{console.log(e)})),"unqueue"===e&&ot(t),"stash::file"===e&&rt(t,s,"file"),"stash::url"===e&&rt(t,s,"url"),"reset"===e&&function(e){const t=st.find((t=>t.oid===`${e}`));null!=t&&(t.reset(),nt.delete(t.oid),pt(`${t.oid}${V.playlist.slot.state}`,"dequeued"),ct())}(t)}function Os(){if(Ht){const e=wt(),t=ws.internal.envelope.value,s=pe(t);s?Ht.set(e,s):Ht.set(e,ye),ws.internal.load.highlight=!1}}function Es(){if(Jt){const e=wt(),t=ws.internal.envelope.value,s=pe(t);Jt.set(e,s)}}function Fs(e){pe(e)&&(Ht&&Os(),Jt&&Es())}function Ms(e){return vs*e/360}function Cs(e,t,s){return Math.min(Math.max(e,t),s)}function Ts(e,t,s,a){const n=new CustomEvent(e,{detail:{oid:t+s,value:a}});Y(n)}function Gs(e,t){switch(!0){case e.length<25:return e;case"start"===t&&!e.toLowerCase().endsWith(".mid"):return`‚Ä¶${e.slice(-25)}`;case"start"===t&&e.toLowerCase().endsWith("mid"):return`‚Ä¶${e.slice(-29,-4)}`;default:return`${e.substring(0,25)}‚Ä¶`}}const Ls=new Map;function Rs(e){!function(e){const t=structuredClone(Vs),s=Ds(e);[...Ds(t)].filter((([e,t])=>s.has(e))).forEach((([e,t])=>Ls.set(t,s.get(e))))}(e);const t=(e,t)=>Ls.has(e)?Ls.get(e):t;ws.gain=t(`${z.synth}${V.synth.settings.gain}`,ws.gain);!function(...e){for(const t of e)for(const e of bt.values())P.matches(t.oid,e.oid)&&(e.multiplier=t.multiplier,e.eccentricity=t.eccentricity,e.sensitivity=t.sensitivity,e.rotation=t.rotation,e.amplitude=t.amplitude,e.shiftx=t.shiftx,e.shifty=t.shifty,e.phase=t.phase,e.psi=t.psi,e.balance=t.balance,e.shape=t.shape)}(...[I,H,J].map((e=>({oid:e,multiplier:t(`${e}${V.oscillator.multiplier}`,null),eccentricity:t(`${e}${V.oscillator.eccentricity}`,null),sensitivity:t(`${e}${V.oscillator.sensitivity}`,null),rotation:t(`${e}${V.oscillator.rotation}`,null),amplitude:t(`${e}${V.oscillator.amplitude}`,null),shiftx:t(`${e}${V.oscillator.shiftx}`,null),shifty:t(`${e}${V.oscillator.shifty}`,null),phase:t(`${e}${V.oscillator.phase}`,null),psi:t(`${e}${V.oscillator.psi}`,null),balance:t(`${e}${V.oscillator.balance}`,null),shape:t(`${e}${V.oscillator.shape}`,null)}))));const s={oid:t(`${z.synth}${V.synth.envelope.oid}`,null),attack:t(`${z.synth}${V.synth.envelope.attack}`,null),decay:t(`${z.synth}${V.synth.envelope.decay}`,null),sustain:t(`${z.synth}${V.synth.envelope.sustain}`,null),release:t(`${z.synth}${V.synth.envelope.release}`,null)};$e(s),fe();const a=[Z,ee,te,se].map((e=>({oid:e,on:t(`${e}${V.lfo.on}`,null),frequency:t(`${e}${V.lfo.frequency}`,null),min:t(`${e}${V.lfo.range.min}`,null),max:t(`${e}${V.lfo.range.max}`,null),plug:Rt(t(`${e}${V.lfo.plug}`,""))}))),n=[K,Q,X].map((e=>({oid:e,multiplier:t(`${e}${V.oscillator.multiplier}`,null),eccentricity:t(`${e}${V.oscillator.eccentricity}`,null),sensitivity:t(`${e}${V.oscillator.sensitivity}`,null),rotation:t(`${e}${V.oscillator.rotation}`,null),amplitude:t(`${e}${V.oscillator.amplitude}`,null),shiftx:t(`${e}${V.oscillator.shiftx}`,null),shifty:t(`${e}${V.oscillator.shifty}`,null),phase:t(`${e}${V.oscillator.phase}`,null),shape:t(`${e}${V.oscillator.shape}`,null)})));!function(...e){for(const t of e)for(const e of Pt.values())P.matches(t.oid,e.oid)&&(e.on=t.on,e.frequency=t.frequency,e.range={min:t.min,max:t.max},e.plug=t.plug)}(...a),function(...e){for(const t of e)for(const e of Vt.values())P.matches(t.oid,e.oid)&&(e.multiplier=t.multiplier,e.eccentricity=t.eccentricity,e.sensitivity=t.sensitivity,e.rotation=t.rotation,e.amplitude=t.amplitude,e.shiftx=t.shiftx,e.shifty=t.shifty,e.phase=t.phase,e.shape=t.shape)}(...n),Yt()}function Bs(){const e=structuredClone(Vs);return js(e),e}function js(e){for(const[t,s]of Object.entries(e))"object"==typeof s?null!==s&&js(s):e[t]=Ls.has(s)?Ls.get(s):void 0}function Ds(e){const t=new Map;for(const[s,a]of Object.entries(e))"object"==typeof a?null!==a&&Ds(a).forEach(((e,a)=>t.set(`${s}.${a}`,e))):t.set(`${s}`,a);return t}const Vs={synth:{song:`${be}${V.playlist.song.title}`,file:`${be}${V.playlist.song.file}`,gain:`${me}${V.synth.settings.gain}`,volume:`${me}${V.synth.settings.volume}`},oscillators:{red:{multiplier:`${I}${V.oscillator.multiplier}`,eccentricity:`${I}${V.oscillator.eccentricity}`,sensitivity:`${I}${V.oscillator.sensitivity}`,rotation:`${I}${V.oscillator.rotation}`,amplitude:`${I}${V.oscillator.amplitude}`,shiftx:`${I}${V.oscillator.shiftx}`,shifty:`${I}${V.oscillator.shifty}`,phase:`${I}${V.oscillator.phase}`,psi:`${I}${V.oscillator.psi}`,balance:`${I}${V.oscillator.balance}`,shape:`${I}${V.oscillator.shape}`},green:{multiplier:`${H}${V.oscillator.multiplier}`,eccentricity:`${H}${V.oscillator.eccentricity}`,sensitivity:`${H}${V.oscillator.sensitivity}`,rotation:`${H}${V.oscillator.rotation}`,amplitude:`${H}${V.oscillator.amplitude}`,shiftx:`${H}${V.oscillator.shiftx}`,shifty:`${H}${V.oscillator.shifty}`,phase:`${H}${V.oscillator.phase}`,psi:`${H}${V.oscillator.psi}`,balance:`${H}${V.oscillator.balance}`,shape:`${H}${V.oscillator.shape}`},blue:{multiplier:`${J}${V.oscillator.multiplier}`,eccentricity:`${J}${V.oscillator.eccentricity}`,sensitivity:`${J}${V.oscillator.sensitivity}`,rotation:`${J}${V.oscillator.rotation}`,amplitude:`${J}${V.oscillator.amplitude}`,shiftx:`${J}${V.oscillator.shiftx}`,shifty:`${J}${V.oscillator.shifty}`,phase:`${J}${V.oscillator.phase}`,psi:`${J}${V.oscillator.psi}`,balance:`${J}${V.oscillator.balance}`,shape:`${J}${V.oscillator.shape}`}},envelope:{oid:`${me}${V.synth.envelope.oid}`,attack:`${me}${V.synth.envelope.attack}`,decay:`${me}${V.synth.envelope.decay}`,sustain:`${me}${V.synth.envelope.sustain}`,release:`${me}${V.synth.envelope.release}`},LFOs:{lfo1:{on:`${Z}${V.lfo.on}`,frequency:`${Z}${V.lfo.frequency}`,min:`${Z}${V.lfo.range.min}`,max:`${Z}${V.lfo.range.max}`,plug:`${Z}${V.lfo.plug}`},lfo2:{on:`${ee}${V.lfo.on}`,frequency:`${ee}${V.lfo.frequency}`,min:`${ee}${V.lfo.range.min}`,max:`${ee}${V.lfo.range.max}`,plug:`${ee}${V.lfo.plug}`},lfo3:{on:`${te}${V.lfo.on}`,frequency:`${te}${V.lfo.frequency}`,min:`${te}${V.lfo.range.min}`,max:`${te}${V.lfo.range.max}`,plug:`${te}${V.lfo.plug}`},lfo4:{on:`${se}${V.lfo.on}`,frequency:`${se}${V.lfo.frequency}`,min:`${se}${V.lfo.range.min}`,max:`${se}${V.lfo.range.max}`,plug:`${se}${V.lfo.plug}`},oscillators:{red:{multiplier:`${K}${V.oscillator.multiplier}`,eccentricity:`${K}${V.oscillator.eccentricity}`,sensitivity:`${K}${V.oscillator.sensitivity}`,rotation:`${K}${V.oscillator.rotation}`,amplitude:`${K}${V.oscillator.amplitude}`,shiftx:`${K}${V.oscillator.shiftx}`,shifty:`${K}${V.oscillator.shifty}`,phase:`${K}${V.oscillator.phase}`,shape:`${K}${V.oscillator.shape}`},green:{multiplier:`${Q}${V.oscillator.multiplier}`,eccentricity:`${Q}${V.oscillator.eccentricity}`,sensitivity:`${Q}${V.oscillator.sensitivity}`,rotation:`${Q}${V.oscillator.rotation}`,amplitude:`${Q}${V.oscillator.amplitude}`,shiftx:`${Q}${V.oscillator.shiftx}`,shifty:`${Q}${V.oscillator.shifty}`,phase:`${Q}${V.oscillator.phase}`,shape:`${Q}${V.oscillator.shape}`},blue:{multiplier:`${X}${V.oscillator.multiplier}`,eccentricity:`${X}${V.oscillator.eccentricity}`,sensitivity:`${X}${V.oscillator.sensitivity}`,rotation:`${X}${V.oscillator.rotation}`,amplitude:`${X}${V.oscillator.amplitude}`,shiftx:`${X}${V.oscillator.shiftx}`,shifty:`${X}${V.oscillator.shifty}`,phase:`${X}${V.oscillator.phase}`,shape:`${X}${V.oscillator.shape}`}}}};const Ps=new class{constructor(){const e=Array.from(document.querySelectorAll("#settings input.field"));this.fields=new Map(e.map((e=>[e.dataset.oid,e]))),this.timestamp=document.querySelector("div#settings label#timestamp input"),this.wavetable=document.querySelector("div#settings label#wavetable input"),this.midi=document.querySelector("div#settings label#smf input");const t=function(){const e={timestamp:!1,wavetable:!1,midi:!1};try{const t=W("settings");null!=t&&(Object.hasOwn(t,"timestamp")&&(e.timestamp=!0===t.timestamp),Object.hasOwn(t,"wavetable")&&(e.wavetable=!0===t.wavetable),Object.hasOwn(t,"midi")&&(e.midi=!0===t.midi))}catch(e){console.error(e)}return e}();this.timestamp.checked=t.timestamp,this.wavetable.checked=t.wavetable,this.midi.checked=t.midi,this.timestamp.onchange=e=>{_s(this.timestamp.checked,this.wavetable.checked,this.midi.checked)},this.wavetable.onchange=e=>{_s(this.timestamp.checked,this.wavetable.checked,this.midi.checked)},this.midi.onchange=e=>{_s(this.timestamp.checked,this.wavetable.checked,this.midi.checked)}}initialise(){Us(this.fields,`${z.synth}${V.synth.settings.volume}`,ws.volume),Us(this.fields,`${z.synth}${V.synth.settings.gain}`,ws.gain);const e=ye;null!=e&&(Us(this.fields,`${z.synth}${V.synth.envelope.oid}`,e.oid),Us(this.fields,`${z.synth}${V.synth.envelope.attack}`,e.attack),Us(this.fields,`${z.synth}${V.synth.envelope.decay}`,e.decay),Us(this.fields,`${z.synth}${V.synth.envelope.sustain}`,e.sustain),Us(this.fields,`${z.synth}${V.synth.envelope.release}`,e.release)),bt.forEach((e=>{Us(this.fields,`${e.oid}${V.oscillator.multiplier}`,e.multiplier),Us(this.fields,`${e.oid}${V.oscillator.eccentricity}`,e.eccentricity),Us(this.fields,`${e.oid}${V.oscillator.sensitivity}`,e.sensitivity),Us(this.fields,`${e.oid}${V.oscillator.rotation}`,e.rotation),Us(this.fields,`${e.oid}${V.oscillator.amplitude}`,e.amplitude),Us(this.fields,`${e.oid}${V.oscillator.shiftx}`,e.shiftx),Us(this.fields,`${e.oid}${V.oscillator.shifty}`,e.shifty),Us(this.fields,`${e.oid}${V.oscillator.phase}`,e.phase),Us(this.fields,`${e.oid}${V.oscillator.psi}`,e.psi),Us(this.fields,`${e.oid}${V.oscillator.balance}`,e.balance),Us(this.fields,`${e.oid}${V.oscillator.shape}`,e.shape)})),Vt.forEach((e=>{Us(this.fields,`${e.oid}${V.oscillator.multiplier}`,e.multiplier),Us(this.fields,`${e.oid}${V.oscillator.eccentricity}`,e.eccentricity),Us(this.fields,`${e.oid}${V.oscillator.sensitivity}`,e.sensitivity),Us(this.fields,`${e.oid}${V.oscillator.rotation}`,e.rotation),Us(this.fields,`${e.oid}${V.oscillator.amplitude}`,e.amplitude),Us(this.fields,`${e.oid}${V.oscillator.shiftx}`,e.shiftx),Us(this.fields,`${e.oid}${V.oscillator.shifty}`,e.shifty),Us(this.fields,`${e.oid}${V.oscillator.phase}`,e.phase),Us(this.fields,`${e.oid}${V.oscillator.shape}`,e.shape)})),Pt.forEach((e=>{Us(this.fields,`${e.oid}${V.lfo.on}`,e.on),Us(this.fields,`${e.oid}${V.lfo.frequency}`,e.frequency),Us(this.fields,`${e.oid}${V.lfo.range.min}`,e.range.min),Us(this.fields,`${e.oid}${V.lfo.range.max}`,e.range.max),Us(this.fields,`${e.oid}${V.lfo.plug}`,e.plug)})),ae("changed",(e=>{Us(this.fields,e.detail.oid,e.detail.value)}),le.synth.any),ae("changed",(e=>{Us(this.fields,e.detail.oid,e.detail.value)}),le.playlist.any),ae("changed",(e=>{const t=ve();null!=t&&(Us(this.fields,`${z.synth}${V.synth.envelope.oid}`,t.oid),Us(this.fields,`${z.synth}${V.synth.envelope.attack}`,t.attack),Us(this.fields,`${z.synth}${V.synth.envelope.decay}`,t.decay),Us(this.fields,`${z.synth}${V.synth.envelope.sustain}`,t.sustain),Us(this.fields,`${z.synth}${V.synth.envelope.release}`,t.release))}),le.synth.envelope),ae("changed",(e=>{const t=ve();null!=t&&(Us(this.fields,`${z.synth}${V.synth.envelope.oid}`,t.oid),Us(this.fields,`${z.synth}${V.synth.envelope.attack}`,t.attack),Us(this.fields,`${z.synth}${V.synth.envelope.decay}`,t.decay),Us(this.fields,`${z.synth}${V.synth.envelope.sustain}`,t.sustain),Us(this.fields,`${z.synth}${V.synth.envelope.release}`,t.release))}),le.envelopes.any),ae("changed",(e=>{Us(this.fields,e.detail.oid,e.detail.value)}),le.SN.any),ae("changed",(e=>{Us(this.fields,e.detail.oid,e.detail.value)}),le.LFO.any)}save(){const e={version:1,settings:Bs()};if(this.wavetable.checked&&(e.wavetable=we(wt(),360).map((e=>function(e){return Math.round(1e5*e)/1e5}(e)))),this.midi.checked&&null!=at.current&&null!=at.current.data&&at.current.data.length>0){const t=at.current,s=Array.from(t.data);e.midi={name:t.name,file:t.file,data:[...s]}}const t=Object.hasOwn(e,"midi")?JSON.stringify(e):JSON.stringify(e,null,4);!async function(e,t,s){const a=new Date,n=`${a.getFullYear()}`.padStart(4,"0"),i=`${a.getMonth()+1}`.padStart(2,"0"),l=`${a.getDate()}`.padStart(2,"0"),o=`${a.getHours()}`.padStart(2,"0"),r=`${a.getMinutes()}`.padStart(2,"0"),c=`${a.getSeconds()}`.padStart(2,"0"),h=t?`snyth ${n}-${i}-${l} ${o}.${r}.${c}.json`:"snyth.json";if(window.showSaveFilePicker)!async function(e,t){try{const s={suggestedName:t,types:[{description:"snyth settings",accept:{"application/json":[".json"]}}]},a=await window.showSaveFilePicker(s),n=await a.createWritable();await n.write(e),await n.close()}catch(e){"AbortError"!==e.name&&console.error(e)}}(e,h);else{const t=URL.createObjectURL(e),s=document.querySelector("div#settings a#settings-download");s.href=t,s.download="snyth.json",s.click(),URL.revokeObjectURL(t)}}(new Blob([t],{type:"application/json"}),this.timestamp.checked)}restore(e){e.text().then((e=>JSON.parse(e))).then((e=>(Rs(e.settings),e))).then((e=>{if(Object.hasOwn(e,"midi")){const t=e.midi.name,s=e.midi.file,a=new Uint8Array(e.midi.data),n=Qe(Ke(a.buffer)).notes;ws.prepare(s,t,n,a)}})).catch((e=>console.log(e)))}clear(){}};function Us(e,t,s){if(function(e,t){Ls.set(e,t)}(t,s),e.has(t)){const a=e.get(t);switch(a.dataset.format){case"%d":return void(a.value=(Math.round(1*s)/1).toFixed(0));case"%¬∞":return void(a.value=`${(Math.round(1*s)/1).toFixed(0)}¬∞`);case"%.1f":return void(a.value=(Math.round(10*s)/10).toFixed(1));case"%.2f":return void(a.value=(Math.round(100*s)/100).toFixed(2));case"%.3f":return void(a.value=(Math.round(1e3*s)/1e3).toFixed(3));case"%%":return void(a.value=`${Math.round(100*s).toFixed(0)}‚ÄØ%`);case"%ms":return void(a.value=`${Math.round(1e3*s).toFixed(0)}‚ÄØms`);case"%#":{const e=s.match(/^(?:.*?)\.([1-9][0-9]*)$/);a.value=null==e?"":`#${e[1]}`}return;case"%b":return void(a.value=!0===s?"ON":"OFF");case"%s":return void(a.value=s);case"%plug":return void(a.value=Nt.has(s)?Nt.get(s):"");default:a.value=s}}}function _s(e,t,s){_("settings",{timestamp:e,wavetable:t,midi:s})}const Ws=window.AudioContext||window.webkitAudioContext;let Ys;function zs(){Ps.save()}function Is(e){Ps.restore(e)}function Hs(){Ps.clear()}function Js(){ws.initialise(),us.initialise(),gs.initialise(),os.initialise(),Ps.initialise(),ws.prepare("./midi/greensleeves.mid","Greensleeves",Ze)}async function Ks(){try{Ys||(Ys=new Ws),await Ys.resume();const e=new Map([["wavetable",await Zs(Ys)],["dds",await ea(Ys)],...await ta(Ys)]);ws.onPowerUp(Ys,e)}catch(e){console.error(`${e}`)}}async function Qs(){Ys&&(await Ys.suspend(),Ys.close(),Ys=null),ws.onPowerDown()}function Xs(e,t){const s=s=>{const a=function(e){for(const t of e.tracks)return Ie(t);return""}(Ke(s));e.title=a,e.url=t};t&&""!==t.trim()&&function(e){return fetch(e,{method:"GET",mode:"cors",cache:"no-cache",credentials:"same-origin",redirect:"follow",referrerPolicy:"no-referrer",headers:{Accept:"application/octet-stream","Accept-Encoding":"gzip"}})}(`${t}`).then((e=>(e=>{if(200===e.status)return e.blob();throw new Error(e.statusText)})(e))).then((e=>e.arrayBuffer())).then((e=>s(e))).catch((e=>{console.log(e)}))}async function Zs(e){try{return await Ys.audioWorklet.addModule("./javascript/wavetable.js"),new Be(Ys)}catch(e){console.error(`${e}`)}return null}async function ea(e){try{return await Ys.audioWorklet.addModule("./javascript/dds.js"),new je(Ys)}catch(e){console.error(`${e}`)}return null}async function ta(e){try{return await Ys.audioWorklet.addModule("./javascript/lfo.js"),new Map([["lfo.1",new De(Ys,"lfo.1")],["lfo.2",new De(Ys,"lfo.2")],["lfo.3",new De(Ys,"lfo.3")],["lfo.4",new De(Ys,"lfo.4")]])}catch(e){console.error(`${e}`)}return null}export{Hs as clear,Js as initialise,Qs as powerOff,Ks as powerOn,Is as restore,zs as save,Xs as setSlot};
