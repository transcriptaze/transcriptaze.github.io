import{ae as e,H as t,ap as s,aq as a,N as i,ar as n,as as r}from"./notes-715bae62.js";const o=2*Math.PI,l=.15,h=.15,m=Math.hypot(l,h/2);function u(e){const t=l*Math.cos(e),s=l*Math.sin(e),a=(e,t)=>m-Math.hypot(e,t),i=a(t,s-h/2),n=a(t,s+h/2);return{"ğœ“l":o*i/343,"ğœ“r":o*n/343}}function p(e,t,s,a){return function(e,t,s,a,i,n,r){let o=1;switch(t.state){case"x":o=0;break;case"A":{const s=e-t.onset;o=s<=a?c(s/a,0,1,1):n+c(1-(s-a)/i,0,1,1)*(1-n)}break;case"R":o=t.level*c(1-(e-t.release)/r,0,1,0)}"A"===t.state?t.level=o:"R"===t.state&&o<=0&&(t.state="x");return{snl:s.left.map((e=>o*e)),snr:s.right.map((e=>o*e))}}(t,s,a,e.attack,e.decay,e.sustain,e.release)}function c(e,t,s,a){const i=Math.min(Math.max(e,t),s);return Number.isNaN(i)?a:i}class f{constructor(){this.internal={notes:new Map,keys:[],sortkey:"default"},y(this)}*[Symbol.iterator](){const e=this.keys,t=this.notes;for(const s of e)yield t.get(s)}get size(){return this.internal.notes.size}get empty(){return 0===this.internal.notes.size}get notes(){return this.internal.notes}get keys(){return this.internal.keys}set keys(e){this.internal.keys=e}get sortkey(){return this.internal.sortkey}set sortkey(e){this.internal.sortkey=e}add(...e){for(const t of e)this.internal.notes.set(t.ID,t);y(this)}release(...e){for(const{ID:t,at:s,release:a}of e){const e=this.notes.get(t);null!=e&&(e.state="R",e.release=s,e.envelope.release=a)}}flush(){const e=[];this.notes.forEach((t=>{"x"===t.state&&e.push(t.ID)})),e.length>0&&(e.forEach((e=>this.internal.notes.delete(e))),y(this))}clear(){this.internal.notes=new Map,y(this)}}function y(e){const t=e.notes,s=`${e.sortkey}`,a=Array.from(t.keys());s.includes("onset")&&a.sort(((e,s)=>t.get(e).onset-t.get(s).onset)),s.includes("reverse")&&a.reverse(),e.keys=a}const g=2*Math.PI,d=64,v=64*Float64Array.BYTES_PER_ELEMENT,x=64*Float64Array.BYTES_PER_ELEMENT,b=new Map([["volume",0],["gain",1],["attack",2],["decay",3],["sustain",4],["release",5],["R.Îµ",6],["R.ğ—Œ",7],["R.Î¸",8],["R.a",9],["R.Î´x",10],["R.Î´y",11],["R.Î¦",12],["R.ğœ“",13],["R.b",14],["G.Îµ",15],["G.ğ—Œ",16],["G.Î¸",17],["G.a",18],["G.Î´x",19],["G.Î´y",20],["G.Î¦",21],["G.ğœ“",22],["G.b",23],["B.Îµ",24],["B.ğ—Œ",25],["B.Î¸",26],["B.a",27],["B.Î´x",28],["B.Î´y",29],["B.Î¦",30],["B.ğœ“",31],["B.b",32]]);class k extends AudioWorkletProcessor{constructor(i,n){super(),this.id=i,this.threshold=n,this.fs=44100,this.port.onmessage=this.onMessage.bind(this),this.queue=[],this.qID=1e3,this.notelist=new f,this.envelope=e,this.notelist.sortkey="onset,reverse",this.metrics={power:0,level:0,volume:0,clipping:0,dropping:0,duration:0,notes:0,maxNotes:0},this.playing=!1,this.paused=!1,this.queued=0,this.currentTime={last:0,now:0},this.sab={parameters:new SharedArrayBuffer(2*v),variations:new SharedArrayBuffer(v),metrics:new SharedArrayBuffer(x),wavetable:null,version:0},this.plugs={lfo1:"volume",lfo2:"gain",lfo3:"",lfo4:""},this.patchbay=new Float64Array(this.sab.variations,0,64),this.patchbay.fill(1),t(0,a,s,this.sab.parameters,0),t(0,a,s,this.sab.parameters,1),this.port.postMessage({message:"sab.parameters",sab:this.sab.parameters,size:64,pages:2,version:this.sab.version}),this.port.postMessage({message:"sab.variations",sab:this.sab.variations,size:64,pages:1,version:0}),this.port.postMessage({message:"sab.metrics",sab:this.sab.metrics,size:64,pages:1,version:0})}static get parameterDescriptors(){return[{name:"volume",defaultValue:1,minValue:0,maxValue:1,automationRate:"k-rate"},{name:"gain",defaultValue:.2,minValue:-1,maxValue:1,automationRate:"k-rate"},{name:"lfo1",defaultValue:1,minValue:-2,maxValue:2,automationRate:"k-rate"},{name:"lfo2",defaultValue:1,minValue:-2,maxValue:2,automationRate:"k-rate"},{name:"lfo3",defaultValue:1,minValue:-2,maxValue:2,automationRate:"k-rate"},{name:"lfo4",defaultValue:1,minValue:-2,maxValue:2,automationRate:"k-rate"}]}onMessage(e){switch(e.data.message){case"parameters.updated":this.sab.version=e.data.version;break;case"keyPressed":this.onKeyPressed(e);break;case"keyReleased":this.onKeyReleased(e);break;case"play":this.onPlay(e);break;case"pause":this.onPause(e);break;case"stop":this.onStop(e);break;case"patch":this.patch(e.data.lfo,e.data.plug)}}patch(e,t){switch(e){case"lfo.1":this.plugs.lfo1=t;break;case"lfo.2":this.plugs.lfo2=t;break;case"lfo.3":this.plugs.lfo3=t;break;case"lfo.4":this.plugs.lfo4=t}this.patchbay.fill(1)}onKeyPressed(e){const t=this.currentTime.now,s=e.data.note,a=i.get(s).key;this.queue.push({noteID:a,event:"noteOn",note:s,velocity:100,at:t})}onKeyReleased(e){const t=this.currentTime.now,s=e.data.note,a=i.get(s).key;this.queue.push({noteID:a,event:"noteOff",note:s,at:t})}onPlay(e){if(this.paused)this.paused=!1,this.port.postMessage({message:"state",timestamp:currentTime,state:"playing"});else if(!this.playing){const t=[];e.data.song.forEach((e=>{const s=++this.qID;t.push({noteID:s,event:"noteOn",note:e.note,velocity:e.velocity,at:e.start}),t.push({noteID:s,event:"noteOff",note:e.note,at:e.end})})),this.queue=[...t],this.queued=this.queue.length,this.playing=!0,this.paused=!1,this.currentTime.last=currentTime,this.currentTime.now=0,this.metrics.notes=0,this.metrics.maxNotes=0,this.port.postMessage({message:"state",timestamp:currentTime,state:"playing"})}}onPause(e){this.paused=!0,this.port.postMessage({message:"state",timestamp:currentTime,state:"paused"})}onStop(e){this.queue=[],this.notelist.clear(),this.playing=!1,this.paused=!1,this.port.postMessage({message:"state",timestamp:currentTime,state:"stopped"})}unpack(){const e=this.patchbay,{version:t,parameters:s,envelope:a}=function(e,t){const s=t%2,a=new Float64Array(e,s*v,d),i=n(a),o=r(a);return{version:t,parameters:i,envelope:o}}(this.sab.parameters,this.sab.version);return s[0].parameters.e*=e[6],s[0].parameters.s*=e[7],s[0].parameters.Î¸*=e[8],s[0].parameters.h*=e[9],s[0].parameters.Î´x*=e[10],s[0].parameters.Î´y*=e[11],s[0].parameters.Î¦*=e[12],s[0].parameters["ğœ“"]*=e[13],s[0].parameters.balance*=e[14],s[1].parameters.e*=e[15],s[1].parameters.s*=e[16],s[1].parameters.Î¸*=e[17],s[1].parameters.h*=e[18],s[1].parameters.Î´x*=e[19],s[1].parameters.Î´y*=e[20],s[1].parameters.Î¦*=e[21],s[1].parameters["ğœ“"]*=e[22],s[1].parameters.balance*=e[23],s[2].parameters.e*=e[24],s[2].parameters.s*=e[25],s[2].parameters.Î¸*=e[26],s[2].parameters.h*=e[27],s[2].parameters.Î´x*=e[28],s[2].parameters.Î´y*=e[29],s[2].parameters.Î¦*=e[30],s[2].parameters["ğœ“"]*=e[31],s[2].parameters.balance*=e[32],{version:t,parameters:s,envelope:a}}process(e,t,s){const a=t[0],i=a[0].length;return this.paused?this.pause(a,i,s):this.synthesize(a,i,s),!0}pause(e,t,s){for(let s=0;s<t;s++)e[0][s]=0,e[1][s]=0;this.currentTime.last=currentTime}synthesize(e,t,s){const a=currentTime-this.currentTime.last,i=this.currentTime.now+a;this.currentTime.last=currentTime,this.currentTime.now=i,this.dequeue(s);const n=this.patchbay,r=[this.plugs.lfo1,this.plugs.lfo2,this.plugs.lfo3,this.plugs.lfo4],o=[s.lfo1[0],s.lfo2[0],s.lfo3[0],s.lfo4[0]];r.forEach(((e,t)=>{if(b.has(e)){const s=b.get(e),a=function(e,t){const s=M.get(e),a=null==s?0:s.min,i=null==s?1:s.max,n=a+(i-a)*t/2;return Math.min(Math.max(n,a),i)}(e,o[t]);n[s]=a}})),this.sn(e,t,s,this.notefn()),function(e,t){const s=new Float64Array(e,0,64);s[0]=t.power,s[1]=t.level,s[2]=t.volume,s[3]=t.clipping,s[4]=t.dropping,s[5]=t.duration,s[6]=t.notes,s[7]=t.maxNotes}(this.sab.metrics,this.metrics)}notefn(){return(e,t,s)=>({snl:new Float32Array(t),snr:new Float32Array(t)})}sn(e,t,s,a){const i=s.volume[0],n=s.gain[0],r=this.currentTime.now,o=this.patchbay,l=i*o[0],h=n*o[1],m=new Float32Array(t),u=new Float32Array(t);let c=0;for(const e of this.notelist){c++;const s=g*e.frequency/this.fs,n=i<.1?w(e,t):a(e,t,c),o={left:n.snl.map((t=>t*e.velocity/127)),right:n.snr.map((t=>t*e.velocity/127))},l=p(e.envelope,r,e,o);l.snl.forEach(((e,t)=>{m[t]+=e})),l.snr.forEach(((e,t)=>{u[t]+=e})),e.alpha+=s*t,e.alpha%=g}let f=0,y=!1;const d=this.notelist.size>this.threshold;for(let s=0;s<t;s++){const t=R(h*m[s],-1,1),a=R(h*u[s],-1,1),i=t*t+a*a;e[0][s]=l*t,e[1][s]=l*a,f+=i,(i<=-1||i>=1)&&(y=!0)}if(this.flush(),Number.isNaN(f))console.error({power:f});else{this.metrics.power=f,this.metrics.volume=l,this.metrics.duration=this.playing?this.currentTime.now:0;const e=Math.sqrt(f/t);e>this.level?this.metrics.level=.2*this.metrics.level+.8*e:this.metrics.level=.95*this.metrics.level+.05*e,this.metrics.clipping=y?1:.995*this.metrics.clipping,this.metrics.dropping=d?1:.995*this.metrics.dropping,this.metrics.notes=this.notelist.size,this.metrics.maxNotes=Math.max(this.metrics.maxNotes,this.notelist.size)}}dequeue(t){const s=this.currentTime.now,a=this.patchbay,n=null==this.envelope?e:this.envelope,r=n.attack*a[2],o="AR"===n.type?0:this.envelope.decay*a[3],l="AR"===n.type?1:this.envelope.sustain*a[4],h=n.release*a[5],m=[],u=[];this.queue.forEach(((e,t)=>{if(e&&!(e.at>s)&&e.at<=s){if(delete this.queue[t],this.queued--,"noteOn"===e.event){const t={ID:e.noteID,note:e.note,velocity:e.velocity,frequency:i.get(e.note).frequency,state:"A",onset:s,level:0,alpha:0,envelope:{attack:r,decay:o,sustain:l,release:h}};m.push(t)}"noteOff"===e.event&&u.push({ID:e.noteID,at:s,release:h})}})),this.notelist.add(...m),this.notelist.release(...u)}flush(){this.notelist.flush(),this.queued<=0&&this.notelist.empty&&this.playing&&(this.playing=!1,this.paused=!1,this.port.postMessage({message:"state",timestamp:this.currentTime.now,state:"stopped"}))}}function w(e,t){return{snl:new Float32Array(t),snr:new Float32Array(t)}}function R(e,t,s){return Math.min(Math.max(e,t),s)}const M=new Map([["R.Îµ",{min:-1,max:1}],["G.Îµ",{min:-1,max:1}],["B.Îµ",{min:-1,max:1}],["R.ğ—Œ",{min:0,max:1}],["G.ğ—Œ",{min:0,max:1}],["B.ğ—Œ",{min:0,max:1}],["R.Î¸",{min:-1,max:1}],["G.Î¸",{min:-1,max:1}],["B.Î¸",{min:-1,max:1}],["R.a",{min:0,max:1}],["G.a",{min:0,max:1}],["B.a",{min:0,max:1}],["R.Î´x",{min:0,max:1}],["G.Î´x",{min:0,max:1}],["B.Î´x",{min:0,max:1}],["R.Î´y",{min:0,max:1}],["G.Î´y",{min:0,max:1}],["B.Î´y",{min:0,max:1}],["R.ğœ“",{min:-1,max:1}],["G.ğœ“",{min:-1,max:1}],["B.ğœ“",{min:-1,max:1}],["R.b",{min:-1,max:1}],["G.b",{min:-1,max:1}],["B.b",{min:-1,max:1}]]);export{k as S,u as h};
