<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8">
    <title>transcriptaze - MIDIASM</title>
    <link rel="icon"       href="images/favicon.png">
    <link rel="stylesheet" href="css/transcriptaze.css" type="text/css">
    <link rel="stylesheet" href="css/midiasm.css" type="text/css">
    <script src="./javascript/wasm_exec.js"></script>
    <script>
      var onComplete

      document.addEventListener('readystatechange', event => {
        switch (event.target.readyState) {
          case 'complete':           
              const go = new Go()
              WebAssembly
                .instantiateStreaming(fetch("./wasm/midiasm.wasm"), go.importObject)
                .then((result) => {
                  onComplete('document')
                  go.run(result.instance)
                })
              break;
        }
      })
    </script>
  </head>

  <body> 
    <div id="content">

      <!-- HEADER -->
      <header>
        <img id="logo" src="images/logo.png" />
        
        <div id="banner">
          <div id="nav">
           <a href="./T2B.html">T2B</a>
           <a href="./W2P.html">W2P</a>
           <a class="active" href=".">MIDIASM</a>
          </div>
          <div>
           <p id="blurb">
            In-browser utility to display the contents of a standard MIDI file
            <br/><br/>
            -- IN DEVELOPMENT --
           </p>
          </div>
        </div>

        <div id="github">          
          <a href="https://github.com/transcriptaze" target="_blank">
            <span><img src="images/github-brands.svg" draggable="false"/>GitHub</span>
          </a>
        </div>
      </header>

      <!-- NAV -->
      <nav>
      </nav>

      <!-- MAIN -->
      <main>
        <div>
          <div id="container">
            <div id="midi" class="panel" ondrop="onDrop(event)"  ondragover="onDragOver(event)">
              <!-- FILE PICKER -->
              <div id="picker" class="picker">                  
                <input id="file" type="file" accept="audio/midi"  onchange="onPicked(event)" style="display: none;" />
                <img onclick="return onPick(event)" src="/images/midi.png" />
                <div id="message">&nbsp;</div>
              </div>

              <!-- WINDMILL -->
              <div id="loading" class="overlay">
                <div id="windmill" class="overlay">
                  <span class="windmill"></span>
                </div>
              </div>
            
              <!-- MIDI -->
              <div id="disassembly">
                <table>
                  <tr>
                    <td class="bytes">4D 54 68 64 00 00 00 06 00 01 00 02 01 E0 </td>
                    <td class="MThd">MThd length:6, format:1, tracks:2, metrical time:480 ppqn</td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- TOOLBOX -->
            <div id="right" class="panel">
            </div>

            <!-- CONTROLS -->
            <div id="controls" class="panel">
            </div>

          </div>
        </div>
      </main>

      <!-- FOOTER -->
      <footer>
      </footer>
    </div>
  </body>

  <!-- SCRIPTS -->
 
  <script type="module">
    import { onMIDI } from "/javascript/midiasm.js"

    window.onMIDI = onMIDI
  </script>

  <script type="text/javascript">
    function onDrop(event) {
      event.preventDefault()

      let files = []

      if (event.dataTransfer.files) {
        files = Array.prototype.map.call(event.dataTransfer.files, f => f)
      } else if (event.dataTransfer.items) {
        files = Array.prototype.filter.call(event.dataTransfer.items, f => f.kind === 'file').map(g => g.getAsFile())
      }

      onMIDI(files)
    }

    function onDragOver(event) {
      event.preventDefault()
    }

    function onPick(event) {
      const input = document.getElementById('file')
      
      input.value = null
      input.click()
    }

    function onPicked(event) {
      const files = Array.prototype.map.call(event.target.files, f => f)

      onMIDI(files)
    }

    // Defer doing anything useful until WASM is loaded and everything is ready
    // (modules are loaded after scripts, Github pages are static, etc)
    const complete = new Promise((resolve) => { 
      onComplete = resolve 
    })

    Promise.all([complete]).then((v) => {
      console.log("'k, ready'ish'")
    })
  </script>

</html>
